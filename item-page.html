<script>
    function loadItem(itemId) {
        console.log(`loadItem(${itemId})`);
        db.collection("items").doc(itemId)
            .get().then((doc) => {
                if (doc.exists) {
                    console.log("Item data:", doc.data());
                    data = doc.data();
                    if (authUser.uid === data.user) {
                        const brand = data.brand;
                        const images = data.images;
                        const infoRequests = data.infoRequests;
                        let imgUrl = images.frontImage;
                        if (images.frontImageSmall) {
                            imgUrl = images.frontImageSmall;
                        }
                        const status = data.status;
                        const category = data.category ? data.category : "";
                        let statusText = ""
                        let publishedDate = data.publishedDate;
                        let daysLeftText = "";
                        if (data.publishedDate) {
                            publishedDate = new Date(publishedDate);
                            let nowDate = new Date();
                            let timeDifference = nowDate.getTime() - publishedDate.getTime();
                            let daysDifference = timeDifference / (1000 * 3600 * 24);
                            let daysLeft = Math.round(30 - daysDifference);
                            if (daysLeft <= 0) {
                                daysLeftText = `0 dagar kvar`;
                            } else {
                                daysLeftText = `${daysLeft} dagar kvar`;
                            }
                        }
                        let min = data.minPriceEstimate;
                        let max = data.maxPriceEstimate;
                        const valuationText = min && max ? `${min}-${max} kr` : "";

                        let text1 = "";
                        let text2 = "";

                        if (status === "New") {
                            if (infoRequests?.price?.status === "Active") {
                                statusText = `Inväntar ditt svar`;
                                text1 = "På huvudsidan kan du se plaggets värdering och<br>välja om du vill sälja till värderingen eller inte.";
                            } else if (min && max) {
                                statusText = `Förbereds`;
                                text1 = "Förbereder det sista inför publicering.<br>Du får ett SMS när försäljningen påbörjas.";
                                text2 = valuationText;
                            } else {
                                statusText = `Värdering pågår`;
                                text1 = "Du får ett SMS när värderingen är klar.<br>Värderingen tar normalt 2 vardagar.";
                            }
                        }
                        if (status === "Published" && min && max) {
                            statusText = `Försäljning pågår`;
                            text1 = daysLeftText;
                            text2 = valuationText;
                        }


                        var pageTitleComponentHTML = `
                            <div class="div-block-102">
                                <div id="itemBrandText" class="text-block-16-copy">${brand}</div>
                                <div id="itemCategoryText" class="text-block-62">${category}</div>
                            </div>`;

                        pageTitleDiv.innerHTML = pageTitleComponentHTML;
                        pageTitleDiv.style.display = "flex";

                        var itemComponentHTML = `
                            <div class="div-block-104"><div class="div-block-103">
                                    <div class="ratio-box _16-9">
                                        <div class="content-block with-image">
                                            <div class="img-container" style="background-image: url('${imgUrl}');"></div>
                                        </div>
                                    </div>
                            </div></div>
                            <div class="div-block-105">
                                <div id="itemStatusText" class="text-block-16-copy">${statusText}</div>
                                <div id="itemText1" class="text-block-63">${text1}</div>
                                <div id="itemText2" class="text-block-63">${text2}</div>
                            </div>`;
                        itemDiv.innerHTML = itemComponentHTML;
                        itemDiv.style.display = "block";
                        loadingDiv.style.display = "none";
                    }
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting item document:", error);
            });
    }

    async function loadItemEvents(itemId) {
        itemEventsDiv.innerHTML = '';
        let response = await fetch(`https://europe-west3-second-hand-helper.cloudfunctions.net/itemEvents/${itemId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        });
        const events = await response.json();
        console.log(events);
        itemAddedEventExists = false;

        if (events) {
            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                if (event.type === 'itemAdded') { itemAddedEventExists = true; }

                // Build lists...
                let style = i === events.length - 1 ? 'highlighted' : '';
                const component = getEventComponent(event, style);
                if (component) {
                    let content = itemEventsDiv.innerHTML;
                    itemEventsDiv.innerHTML = component.concat(content);
                }
            }

            // Show list if itemAdded exists
            if (itemAddedEventExists) { sellingProcessDiv.style.display = 'block'; console.log("Showing events list"); }
        }
    }

    function getEventComponent(event, style) {
        let component = '';
        let text = '';
        let time = '';
        let className = '';
        let icon = '<div class="div-block-143"></div>';
        let displayLine = 'block';

        // Highlighted event styling
        if (style === 'highlighted') {
            className = 'highlighted-event';
            icon = '<img src="https://global-uploads.webflow.com/6297d3d527db5dd4cf02e924/62c53fa9db6d0f383ee430f9_check-mark%202%20(1).svg" loading="lazy" width="auto" alt="">';
        }

        // Set time
        const weekdays = ['Sön', 'Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön']
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec']
        const date = new Date(event.timestamp);
        time = weekdays[date.getDay()] + " " + date.getHours() + ":" + date.getMinutes();
        let now = new Date();
        let daysDiff = Math.round((now.getTime() - date.getTime()) / (1000 * 3600 * 24));console.log("D:", daysDiff);
        if (daysDiff > 6) {time = date.getDate() + " " + months[date.getMonth()] + " " + date.getHours() + ":" + date.getMinutes();}

        // Set text
        if (event.type === 'itemAdded') {
            text = 'Plagg lades upp på Mai';
            displayLine = 'none';
        }
        if (event.type === 'valuationCompleted') { text = `Värderades till ${event.data.min}-${event.data.max} kr`; }
        if (event.type === 'valuationAccepted') { text = `Du accepterade värderingen`; }
        if (event.type === 'itemPublished') { text = `Försäljning påbörjades`; }
        if (event.type === 'priceAdjusted') { text = `Pris sänktes till ${event.data.newPrice} kr`; }
        if (event.type === 'priceRequestSent') { text = `Nytt prisförslag på ${event.data.min}-${event.data.max} kr`; }
        if (event.type === 'priceRequestResponse') {
            if (event.data.response === 'Accepted') {
                text = `Du accepterade prisförslaget`;
            } else if (event.data.response === 'Denied') {
                text = `Du avböjde prisförslaget`;
            }
        }
        if (event.type === 'listingRenewal') { text = `Annonser förnyades`; }
        if (event.type === 'platformAdded') { text = `Publicerades på en till plattform`; }
        if (event.type === 'itemSold') { text = `Såld för ${event.data.soldPrice} kr till ${event.data.buyerFirstName} i ${event.data.buyerAddressCity}`; }
        if (event.type === 'bagSentToSeller') { text = `Fraktpåse skickades till dig`; }
        if (event.type === 'itemSent') {
            text = `Plagget skickades iväg`;
        }
        if (event.type === 'payoutCompleted') { text = `Du fick ${event.data.amount} kr utbetalt`; }

        if (text) {
            component = `
                <div class="div-block-135">
                    <div class="div-block-144">
                        <div class="div-block-142">
                            <div class="div-block-139" style="display: ${displayLine};"></div>
                        </div>
                        <div class="div-block-138">
                            ${icon}
                        </div>
                    </div>
                    <div class="div-block-136">
                        <div class="item-event-text ${className}">${text}</div>
                        <div class="text-block-82">${time}</div>
                    </div>
                </div>`;
        }

        const response = component ? component : false;
        return response;
    }

    editItemLink.addEventListener('click', function () {
        window.location.href = window.location.origin + `/edit-item?id=${params.id}`;
    });

    // Load item
    loadItem(params.id);
    loadItemEvents(params.id);
    //loadItemEvents('3fb6b9eb-48b9-486d-a432-67aeac630ead');
</script>