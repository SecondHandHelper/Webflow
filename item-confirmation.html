<script>
    function initializeSlider(item) {
        const images = item?.images;
        document.getElementById('slider').style.display = 'block';

        const slide = document.getElementById('frontImageSlide');
        const cloneSlide = slide.cloneNode(true);
        const sliderMask = document.getElementById('sliderMask');
        sliderMask.innerHTML = '';

        for (const imageName of ['frontImage', 'enhancedFrontImage', 'brandTagImage', 'materialTagImage', 'extraImage', 'defectImage']) {
            if (images[imageName]) {
                if (imageName === 'frontImage' && images['enhancedFrontImage']) {
                    continue;
                }
                const newSlide = cloneSlide.cloneNode(true);
                newSlide.id = imageName;
                newSlide.firstChild.src = images[imageName];
                sliderMask.appendChild(newSlide);
            }
        }
    }

    function colorName(color) {
        const mapping = { Beige: 'Beige', Blue: 'Blå', Brown: 'Brun', Green: 'Grön', Grey: 'Grå', Yellow: 'Gul', Gold: 'Guld',
            Purple: 'Lila', Navy: 'Navy', Orange: 'Orange', Pink: 'Rosa', Red: 'Röd', Silver: 'Silver', Black: 'Svart',
            Turquoise: 'Turkos', Burgundy: 'Vinröd', White: 'Vit', Multicolour: 'Flerfärgad' };
        return mapping[color] || color;
    }
    
    function initializeFields(item) {
        initializeSlider(item);
        document.getElementById('itemTitle').innerText = (item.cleanedBrand || item.brand).trim() + "-" + item.category.toLowerCase();
        if (item.mlValuation?.humanCheckNeeded || !item.mlValuation?.minPriceEstimate) {
            document.getElementById('nextStepTitle').style.display = 'block';
            document.getElementById('nextStepText').innerText = 'Du kommer få ett SMS när vi värderat plagget som du kan ta ställning till';
        }
        document.getElementById('itemPrice').innerText = item.mlValuation?.maxPriceEstimate && !item.mlValuation?.humanCheckNeeded ?
            `${item.mlValuation.maxPriceEstimate} kr` : '';
        document.getElementById('itemPrice').style.display = 'block';
        document.getElementById('itemColor').innerText = colorName(item.color);
        document.getElementById('itemSize').innerText = item.size;
        document.getElementById('itemMaterial').innerText = item.material;
        document.getElementById('itemCondition').innerText = item.condition = itemConditionText(item);
        if (item.userComment) {
            document.getElementById('itemCommentDiv').style.display = 'block';
            document.getElementById('itemComment').innerText = item.userComment;
        }
    }

    function initializePlatforms(item) {
        (item.platformsToBePublishedOn).forEach(platform => {
            if (!platform.match(/Mai|Tradera/)) {
                const newNode = document.getElementById('platformMai').cloneNode(true);
                newNode.id = platform;
                newNode.innerText = platform;
                document.getElementById('platformMai').parentNode.appendChild(newNode);
            }
        });
        document.getElementById('platformsLoadingDiv').style.display = 'none';
        document.getElementById('platformsDiv').style.display = 'block';
    }

    function itemConditionText(item) {
        if (item.condition === 'Använd, tecken på slitage' && (item.defects.length || item.defectDescription)) {
            return `Anmärkning: ${item.defects ? item.defects + '.' : ''} ${item.defectDescription ? item.defectDescription + '.' : ''}`;
        }
        return item.condition;
    }


    const getItem = async (itemId) => {
        const res = await firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId: itemId  });
        return { ...(res?.data || {}), id: itemId };
    }

    const main = async () => {
        const item = params.id ? await getItem(params.id) : JSON.parse(localStorage.getItem('latestItemCreated'));
        if (!item) {
            console.error("Invalid item id param or no recently created item");
            return location.href = '/private';
        }
        initializeFields(item);
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('contentDiv').style.display = 'block';
        // Show all fields except platformsToBePublishedOn, that is set in the backend so fetch the item before showing it
        if (item.platformsToBePublishedOn?.length) {
            initializePlatforms(item);
        } else {
            firebase.app().functions("europe-west1").httpsCallable('getPlatformsToBePublishedOn')({ itemId: item?.id  })
                .then(response => {
                    if (response.data?.platformsToBePublishedOn?.length >= 2) {
                        initializePlatforms(response.data);
                    } else {
                        document.getElementById('platformsSection').style.display = 'none';
                    }
                })
                .catch(e => console.error(e));
        }
    }

    main();
</script>
