<script>

    function initializeSlider(item) {
        const images = item?.images;
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('slider').style.display = 'block';

        const slide = document.getElementById('frontImageSlide');
        const cloneSlide = slide.cloneNode(true);
        const sliderMask = document.getElementById('sliderMask');
        sliderMask.innerHTML = '';

        const frontImageSlide = cloneSlide.cloneNode(true);
        frontImageSlide.firstChild.src = sessionStorage.getItem('enhancedFrontImageSmall') ||
            images.enhancedFrontImageSmall || images.enhancedFrontImageMedium || images.enhancedFrontImage ||
            images.frontImageSmall || images.frontImage;
        frontImageSlide.id = 'frontImage';
        sliderMask.appendChild(frontImageSlide);
        // Add slides for all other images
        for (const imageName of ['brandTagImage', 'materialTagImage', 'defectImage', 'extraImage']) {
            if (images[imageName]) {
                const newSlide = cloneSlide.cloneNode(true);
                newSlide.id = imageName;
                newSlide.firstChild.src = images[`${imageName}Small`] || images[`${imageName}Medium`] || images[imageName];
                sliderMask.appendChild(newSlide);
            }
        }
    }

    function initializeTextFields(item) {
        if (item.cleanedBrand) {
            document.getElementById('itemTitle').innerText = item.cleanedBrand.trim() + "-" + item.category.toLowerCase();
        } else {
            document.getElementById('itemTitle').innerText = item.cleanedBrand.trim() + "-" + item.category.toLowerCase();
        }
        document.getElementById('itemPrice').innerText = item.minPriceEstimate ? `${item.minPriceEstimate - item.maxPriceEstimate} kr` : '';
        document.getElementById('itemColor').innerText = item.color;
        document.getElementById('itemSize').innerText = item.size;
        document.getElementById('itemMaterial').innerText = item.material;
        document.getElementById('itemCondition').innerText = item.condition = itemConditionText(item);
        if (item.userComment) {
            document.getElementById('itemCommentDiv').style.display = 'block';
            document.getElementById('itemComment').innerText = item.userComment;
        }
        (item.platformsToBePublishedOn || []).forEach(platform => {
            if (!platform.match(/Mai|Tradera/)) {
                const newNode = document.getElementById('platformMai').cloneNode(true);
                newNode.id = platform;
                newNode.innerText = platform;
                document.getElementById('platformMai').parentNode.appendChild(newNode);
            }
        });
    }

    function itemConditionText(item) {
        if (item.condition === 'Använd, tecken på slitage' && (item.defects.length || item.defectDescription)) {
            return `Anmärkning: ${item.defects ? item.defects + '.' : ''} ${item.defectDescription ? item.defectDescription + '.' : ''}`;
        }
        return item.condition;
    }

    function initializeButtons(item) {
        document.getElementById('newItemButton').addEventListener('click', () => location.href = '/sell-item');
        document.getElementById('editItemButton').addEventListener('click', () => location.href = `/sell-item?id=${item.id}`);
    }

    if (localStorage.getItem('latestItemCreated') || params.id) {
        const item = JSON.parse(localStorage.getItem('latestItemCreated'));
        // Show images from latestItemCreated to make it quick then fill in the rest from saved item since it contains
        // more info
        item && initializeSlider(item);
        firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId: item?.id || params.id })
            .then(response => {
                item || initializeSlider(response.data); // Only set slider images if it is not already set from latestItemCreated
                initializeTextFields(response.data);
                initializeButtons(response.data);
            })
            .catch(e => console.error(e));
    } else {
        console.log('No latest item found');
        location.href = '/private';
    }
</script>
