<script>
    function initializeSlider(item) {
        const images = item?.images;
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('slider').style.display = 'block';

        const slide = document.getElementById('frontImageSlide');
        const cloneSlide = slide.cloneNode(true);
        const sliderMask = document.getElementById('sliderMask');
        sliderMask.innerHTML = '';

        const frontImageSlide = cloneSlide.cloneNode(true);
        frontImageSlide.firstChild.src = sessionStorage.getItem('enhancedFrontImageSmall') ||
            images.enhancedFrontImageSmall || images.enhancedFrontImageMedium || images.enhancedFrontImage ||
            images.frontImageSmall || images.frontImage;
        frontImageSlide.id = 'frontImage';
        sliderMask.appendChild(frontImageSlide);
        // Add slides for all other images
        for (const imageName of ['brandTagImage', 'materialTagImage', 'defectImage', 'extraImage']) {
            if (images[imageName]) {
                const newSlide = cloneSlide.cloneNode(true);
                newSlide.id = imageName;
                newSlide.firstChild.src = images[`${imageName}Small`] || images[`${imageName}Medium`] || images[imageName];
                sliderMask.appendChild(newSlide);
            }
        }
    }

    function colorName(color) {
        const mapping = { Beige: 'Beige', Blue: 'Blå', Brown: 'Brun', Green: 'Grön', Grey: 'Grå', Yellow: 'Gul', Gold: 'Guld',
            Purple: 'Lila', Navy: 'Navy', Orange: 'Orange', Pink: 'Rosa', Red: 'Röd', Silver: 'Silver', Black: 'Svart',
            Turquoise: 'Turkos', Burgundy: 'Vinröd', White: 'Vit', Multicolour: 'Flerfärgad' };
        return mapping[color] || color;
    }
    
    function initializeFields(item) {
        initializeSlider(item);
        document.getElementById('itemTitle').innerText = (item.cleanedBrand || item.brand).trim() + "-" + item.category.toLowerCase();
        if (!item.preferences.userValuationApproval) {
            document.getElementById('nextStepText').innerText = 'Vi hör av oss när plagget är sålt och ska skickas.'
        } else if (item.humanCheckNeeded || !item.minPriceEstimate) {
            document.getElementById('nextStepHeader').style.display = 'block';
            document.getElementById('nextStepText').style.color = '#000';
            document.getElementById('nextStepText').innerText = 'Du kommer få ett SMS när vi värderat plagget som du får ta ställning till.';
        }
        document.getElementById('itemPrice').innerText = item.maxPriceEstimate ? `${item.maxPriceEstimate} kr` : '';
        document.getElementById('itemPrice').style.display = 'block';
        document.getElementById('itemColor').innerText = colorName(item.color);
        document.getElementById('itemSize').innerText = item.size;
        document.getElementById('itemMaterial').innerText = item.material;
        document.getElementById('itemCondition').innerText = item.condition = itemConditionText(item);
        if (item.userComment) {
            document.getElementById('itemCommentDiv').style.display = 'block';
            document.getElementById('itemComment').innerText = item.userComment;
        }
    }

    function initializePlatforms(item) {
        (item.platformsToBePublishedOn || []).forEach(platform => {
            if (!platform.match(/Mai|Tradera/)) {
                const newNode = document.getElementById('platformMai').cloneNode(true);
                newNode.id = platform;
                newNode.innerText = platform;
                document.getElementById('platformMai').parentNode.appendChild(newNode);
            }
        });
    }

    function itemConditionText(item) {
        if (item.condition === 'Använd, tecken på slitage' && (item.defects.length || item.defectDescription)) {
            return `Anmärkning: ${item.defects ? item.defects + '.' : ''} ${item.defectDescription ? item.defectDescription + '.' : ''}`;
        }
        return item.condition;
    }

    function initializeButtons() {
        document.getElementById('newItemButton').addEventListener('click', () => location.href = '/sell-item');
        document.getElementById('closeIcon').addEventListener('click', () => location.href = '/private');
    }

    const item = JSON.parse(localStorage.getItem('latestItemCreated'));
    if (item) {
        $(document).ready(() => {
            initializeFields(item);
            initializeButtons();
        });
        // Show all fields except platformsToBePublishedOn, that is set in the backend so fetch the item before showing it
        firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId: item?.id  })
            .then(response => { initializePlatforms(response.data) })
            .catch(e => console.error(e));
    } else {
        console.log('No latest item found');
        location.href = '/private';
    }
</script>
