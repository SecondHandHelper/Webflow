<script>
    const pageSetUp = async () => {
        const item = params.id ?
            await firebase.app().functions("europe-west1").httpsCallable('getItem')({itemId}) :
            JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn'));
        introText.innerText = `För att fullfölja försäljningen av ditt ${item.brand}-plagg behöver vi dina uppgifter. Anges bara en gång.`

        mobilePhone.addEventListener('input', fieldLabelToggle('mobilePhoneLabel'));
        personalId.addEventListener('input', fieldLabelToggle('personalIdLabel'));

        userDetailsClose.addEventListener('click', () => {
            location.href = '/private';
        });

        saveUserDetailsButton.addEventListener('click', async () => {
          const mobilePhoneError = mobilePhone.value?.length < 9 ? 'Ange ditt mobilnummer' : '';
          mobilePhone.setCustomValidity(mobilePhoneError);
          const personalIdError = !personalId.value?.length || isValidSwedishSsn(personalId.value) ?
                  '' : 'Ange ett giltigt personnummer';
          personalId.setCustomValidity(personalIdError);
          if (reportValidity()) {
              try {
                  await firebase.app().functions("europe-west1").httpsCallable('updateFirebaseUser')(
                      { phoneNumber: mobilePhone.value, personalId: personalId.value }
                  );
              } catch (e) {
                  console.error('Failed saving user contact info', e);
              }
              location.href = `/item-confirmation${params.id ? '?id=' + params.id : ''}`;
          }
        });
    }

    pageSetUp();
</script>
