<script>
    var userId;
    var email;
    var phone;
</script>
<script>
    function main() {
        userId = authUser.uid;
        email = authUser.email;
        phone = authUser.phoneNumber;
        emailVerified = authUser.emailVerified;
        updateIC(userId, email, phone);
        askForAdditionalUserDetails(userId);
        updateFirestoreUserDocument(userId, email, phone);
        emptyListsInnerHTML();
        loadSoldByOthers(userId);
        buildCardLists(userId);
        if (!emailVerified && email) {
            window.location.replace('./user-management?mode=sendEmailVerification');
        }
        // Create referral code
        if (user.addressFirstName && user.addressLastName && !user?.referralData?.referralCode) {
            createReferralCode();
        }
        showReferralSection();
    }

    async function showReferralSection() {
        const userCreatedDate = new Date(authUser.metadata.creationTime);
        const now = new Date();
        let daysDiff = (now.getTime() - userCreatedDate.getTime()) / (1000 * 3600 * 24);
        console.log("Days since user registered", daysDiff);
        let soldItemExist = false;

        // Check if an item is sold
        await db.collection("items").where("user", "==", userId).where("status", "==", "Sold").get().then((querySnapshot) => {
            if (querySnapshot.size > 0) {
                soldItemExist = true;
            }
        });

        if (user?.referralData?.referralCode && soldItemExist) {
            document.getElementById("myReferralCodeText").innerHTML = user.referralData.referralCode;
            if (user?.referralData?.activatedReferredUsersCount > 0) {
                console.log("shareCodeState 'block', but should also show the bonus received... TODO");
                shareCodeState.style.display = 'block';
            } else {
                console.log("shareCodeState 'block'");
                shareCodeState.style.display = 'block';
            }
        } else if (user?.referralData?.referredBy && !user?.referralData?.referredByBonusPaid) {
            console.log("referredByBonusState 'block'");
            // Get inviters first name
            const inviter = user?.referralData?.referredBy;
            console.log("inviter", inviter);
            await db.collection("users").doc(inviter).get().then((doc) => {
                if (doc.exists) {
                    const name = doc.data().addressFirstName;
                    document.getElementById("referredByBonusTitle").innerHTML = "Välkomstgåva från " + name;
                }
            });
            referredByBonusState.style.display = 'block';
        } else if ((user?.referralData?.referredBy ? false : true) && daysDiff < 3) {
            console.log("enterCodeState 'block'");
            enterCodeState.style.display = 'block';
        }
        console.log("Showing referral section");
        referralSection.style.display = 'block';
    }

    function createReferralCode() {
        const fn = user.addressFirstName;
        const ln = user.addressLastName;
        let letterCombo = fn.trim() + ln.charAt(0);
        letterCombo = letterCombo.toUpperCase();
        let newCode = letterCombo;

        // Check if letterCombo exists and increase number
        if (!user?.referralData?.referralCode) {
            db.collection("users")
                .where("referralData.referralCode", "!=", "")
                .get()
                .then((querySnapshot) => {
                    let letterComboExists = false;
                    let highestNumber = 0;
                    console.log("Users with referral code: ", querySnapshot.size);
                    querySnapshot.forEach((doc) => {
                        const refCode = doc.data().referralData.referralCode.match(/[a-zA-Z]+|[0-9]+/g); //Split letters and numbers. TOBIASR1 -> ["TOBIASR", "1"]
                        if (refCode[0] == letterCombo) {
                            letterComboExists = true;
                            let n = Number(refCode[1]);
                            if (n > highestNumber) {
                                highestNumber = n;
                            }
                        }
                    });

                    // Put together new code
                    if (letterComboExists) {
                        const number = highestNumber + 1;
                        newCode = letterCombo + number.toString();
                    }

                    // Store referral code
                    db.collection('users').doc(authUser.uid).update({
                        "referralData.referralCode": newCode
                    }).then(function () {
                        console.log("New referral code stored: ", newCode);
                        user.referralData.referralCode = newCode;
                        showReferralSection();
                    });
                });
        }
    }

    function connectReferralUsers() {
        saveRefCodeLoadingDiv.style.display = 'flex';
        saveReferralCodeButton.style.display = 'none';
        const inputCode = referralCodeInput.value.toUpperCase();

        // Find user with matching referral code and connect users
        db.collection("users")
            .where("referralData.referralCode", "!=", "")
            .get()
            .then((querySnapshot) => {
                let inviterUserId;
                for (var i in querySnapshot.docs) {
                    const doc = querySnapshot.docs[i];
                    const refCode = doc.data().referralData.referralCode;
                    if (refCode == inputCode) {
                        inviterUserId = doc.id;
                        break;
                    }
                }

                // CONNECT USERS
                if (inviterUserId && !user?.referralData?.referredBy) {
                    // Add referredBy
                    db.collection('users').doc(authUser.uid).update({
                        "referralData.referredBy": inviterUserId
                    }).then(() => {
                        // Update referredUsers of the inviter
                        db.collection('users').doc(inviterUserId).update({ "referralData.referredUsers": firebase.firestore.FieldValue.arrayUnion(authUser.uid) }).then(() => {
                            referredByBonusState.style.display = 'block';
                            enterCodeState.style.display = 'none';
                            console.log("Referral connection successfully stored");
                        });
                    });
                }
            });
    }

</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackForm.addEventListener("submit", storeFeedback);
        saveReferralCodeButton.addEventListener("click", connectReferralUsers);
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
    });

    shareCodeButton.addEventListener('click', event => {
        const code = user.referralData.referralCode;
        const text = `Hej! Jag vill bjuda in dig till Mai. Använd min kod ${code} när du skapat ett konto och få 100 kr i välkomstgåva när du säljer ditt första plagg.`
        if (navigator.share) {
            navigator.share({
                text: text,
                url: 'https://maiapp.se'
            }).then(() => {
                console.log('Thanks for sharing!');
            })
                .catch(console.error);
        } else {
            // fallback
            console.log("Browser doesn't support navigator.share => Copy to clipboard!");
            const shareText = text + "\nmaiapp.se"
            navigator.clipboard.writeText(shareText);
            linkCopiedText.style.display = 'flex';
            shareCodeButton.style.display = 'none';
        }
    });

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
</script>