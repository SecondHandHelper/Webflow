<script>
    var userId;
    var email;
    var phone;
</script>
<script>
    function main() {
        userId = authUser.uid;
        email = authUser.email;
        phone = authUser.phoneNumber;
        emailVerified = authUser.emailVerified;
        updateIC(userId, email, phone);
        askForAdditionalUserDetails(userId);
        updateFirestoreUserDocument(userId, email, phone);
        emptyListsInnerHTML();
        loadSoldByOthers(userId);
        buildCardLists(userId);
        if (!emailVerified && email) {
            window.location.replace('./user-management?mode=sendEmailVerification');
        }
        // Create referral code
        if (user.addressFirstName && user.addressLastName && !user?.referralData?.referralCode) {
            createReferralCode();
        }
        showReferralSection();
    }

    function getBagReceivedCheckbox(itemId, soldDate) {
        console.log("getBagReceivedCheckbox");
        const div = `<div class="w-form">
            <form method="get" name="wf-form-" id="bagReceivedForm">
                <label class="w-checkbox checkbox-field-3">
                    <div class="w-checkbox-input w-checkbox-input--inputType-custom checkbox-2"></div>
                    <input type="checkbox" id="bagReceivedCheckbox-${itemId}" style="opacity:0;position:absolute;z-index:-1" onclick="javascript:bagReceivedAction(this, '${itemId}', '${soldDate}');">
                    <span class="checkbox-label-3 w-form-label">Påsen har kommit</span>
                </label>
            </form>
        </div>`;
        return div;
    }

    function bagReceivedAction(checkbox, itemId, soldDate) {
        if (checkbox.checked == true) {
            db.collection('items').doc(itemId).update({ bagReceived: true }).then((docRef) => {
                console.log(`Stored in DB that bag is received for item with ID: `, itemId);
            });
            openShippingToast(itemId, soldDate);
        } else {
            db.collection('items').doc(itemId).update({ bagReceived: false }).then((docRef) => {
                console.log(`Stored in DB that bag is NOT received for item with ID: `, itemId);
            });
        }
    }

    function openShippingToast(itemId, soldDate) {
        console.log("openShippingToast");
        window.pickupFlowItemId = itemId;
        shippingOptionsDiv.innerHTML = `<a href="javascript:storeShippingMethod('${itemId}', 'Service point');" class="link-block-22 w-inline-block"><div class="div-block-122">
            <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/62436932a8d26f07254b45e2_parcel.png" loading="lazy" width="45" alt="" class="image-24">
            <div class="small-button-text">Lämna till ombud</div></div>
        </a>
        <a href="javascript:openPickupToast('${itemId}', '${soldDate}');" class="link-block-22 w-inline-block"><div class="div-block-122">
            <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/608db91c363e28ae251e0998_delivery-truck%204.svg" loading="lazy" width="45" alt="" class="image-24">
            <div class="small-button-text">Boka upphämtning</div></div>
        </a>`;
        document.getElementById('triggerShippingToastOpen').click();
    }

    function getShippingInfoDiv(itemId, method, soldDate, pickupDate) {
        let uniquePart = ``;
        if (method == "Service point") {
            uniquePart += `
            <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/62436932a8d26f07254b45e2_parcel.png" loading="lazy" width="26" alt="" class="image-12">
                <div class="next-step-text-small">Lämna till ombud</div>
            `;
        } else if (method == "Pickup") {
            if (pickupDate) {
                var date = new Date(pickupDate);
                var days = ['Söndag', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
                var months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                var dateNumber = date.getDate();
                var monthName = months[date.getMonth()];
                var dayName = days[date.getDay()];
                var pickupTimeInfoText = dayName + ", " + dateNumber + " " + monthName + ", kl 9-16";
                uniquePart += `
                <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/608db91c363e28ae251e0998_delivery-truck%204.svg" loading="lazy" width="28" alt="" class="image-12">
                <div class="next-step-text-small">${pickupTimeInfoText}</div>
            `;
            }
        }

        const div = `
            <div id="shippingInfoDiv" class="div-block-54">
                ${uniquePart}
                <a href="javascript:openShippingToast('${itemId}', '${soldDate}');">
                    <div id="changeShippingMethod-${itemId}" class="change-shipping-method-text">Ändra fraktsätt</div>
                </a>
            </div>`;
        return div;
    }

    async function storeShippingMethod(itemId, method) {
        await db.collection('items').doc(itemId).update({ shippingMethod: method }).then((docRef) => {
            console.log(`Shipping method '${method}' stored on item with ID: `, itemId);
            window.pickupFlowItemId = itemId; // Legacy from before. Bad way of doing it. Should clean up 'pickupFlowItemId' at some point.
            if (method == "Service point") {
                feedbackFormTitle.innerText = 'Tack, då vet vi att paketet snart lämnas till ett ombud.'
                document.getElementById('triggerShippingToastClose').click();
            } else if (method == "Pickup") {
                closePickupToast();
            }
            happinessQuestionText.innerText = `Hur nöjd är du med försäljningen 
av ditt plagg?`;
            
            document.getElementById('triggerFeedbackFormOpen').click();
        });
    }


</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackForm.addEventListener("submit", storeFeedback);
        saveReferralCodeButton.addEventListener("click", connectReferralUsers);
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
    });

    shareCodeButton.addEventListener('click', event => {
        const code = user.referralData.referralCode;
        const text = `Hej! Jag vill bjuda in dig till Mai. Använd min kod ${code} när du skapat ett konto och få 100 kr i välkomstgåva när du säljer ditt första plagg.`
        if (navigator.share) {
            navigator.share({
                text: text,
                url: 'https://maiapp.se'
            }).then(() => {
                console.log('Thanks for sharing!');
            })
                .catch(console.error);
        } else {
            // fallback
            console.log("Browser doesn't support navigator.share => Copy to clipboard!");
            const shareText = text + "\nmaiapp.se"
            navigator.clipboard.writeText(shareText);
            linkCopiedText.style.display = 'flex';
            shareCodeButton.style.display = 'none';
        }
    });

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
</script>