<script>
    var userId;
    var email;
    var phone;
</script>
<script>
    async function main() {
        if (authUser) {
            userId = authUser.uid;
            email = authUser.email;
            phone = authUser.phoneNumber;
            emailVerified = authUser.emailVerified;
            await updateFirestoreUserDocument(authUser.uid, email, phone); //Important that this happen first, since many other functions depend on an existing user document
            updateIC(userId, email, phone);
            askForAdditionalUserDetails(userId);
            loadSoldByOthers(userId);

            //For testing purposes only - To see what a certain user sees
            if (userId === "3OkW5av20HP8ScpUDS8ip9fBEZr1" && window.location.origin.includes("shh-test")) {
                userId = "3OkW5av20HP8ScpUDS8ip9fBEZr1";
            }
            
            if (featureIsEnabled('C2C')) {
                // ### C2C CODE ###
            } else {
                // ### LIVE CODE ###
            }

            const items = await getItems(userId);
            showInviteToast(items);
            loadItemCards(items);
            loadInfoRequests(userId);
            showReferralSection();
            showAccountInfo();
            
            if (!emailVerified && email) {
                let res = getCookie('viewedVerifyEmailDiv');
                viewedVerifyEmailDiv = res === 'true' ? true : false;
                if (!viewedVerifyEmailDiv) {
                    window.location.replace('./user-management?mode=sendEmailVerification');
                }
            }
            // Create refCode
            if (user && user.addressFirstName && user.addressLastName && !user?.referralData?.referralCode) { createReferralCode(); }
        }
    }

    function showAccountInfo() {
        let identifier;
        if (authUser.phoneNumber) {
            identifier = authUser.phoneNumber;
        } else if (authUser.email) {
            identifier = authUser.email;
        }
        if (identifier) {
            accountInfoText.innerHTML = `Inloggad med ${identifier}`;
            accountInfoText.style.display = 'block';
        }
    }

    function showInviteToast(items) {
        let daysSinceLatestSold = 10;
        let soldItemsCount = 0;
        let oneSoldNotSentItemExist = false;
        let viewedToastBefore = user?.elementViews && user.elementViews.some(e => e.elementID === 'inviteToast') ? true : false;

        if (items) {
            items.forEach((doc) => { // Items is a global variable that equals to querySnapshot from loadCardLists.js
                var itemId = doc.id;
                var i = doc.data();
                let soldDate = i.soldDate;
                const status = i.status;
                const shippingStatus = i.shippingStatus;
                const shippingMethod = i.shippingMethod;
                const archived = i.archived;

                if (!archived && status === 'Sold' && soldDate) {
                    soldItemsCount++;
                    if (soldDate) {
                        soldDate = new Date(soldDate);
                        let nowDate = new Date();
                        let timeDifference = nowDate.getTime() - soldDate.getTime();
                        let daysDiff = Math.floor(timeDifference / (1000 * 3600 * 24));
                        if (daysDiff <= daysSinceLatestSold) { daysSinceLatestSold = daysDiff; }
                    }
                    if (shippingStatus !== 'Sent' && !shippingMethod) {
                        oneSoldNotSentItemExist = true;
                    }
                }
            });
        }

        if (daysSinceLatestSold <= 3 && soldItemsCount >= 2 && oneSoldNotSentItemExist && user?.referralData?.referralCode && !viewedToastBefore) {
            triggerInviteToastOpen.click();
            // Store elementViews to be able to not show it again
            db.collection('users').doc(authUser.uid).update({ elementViews: firebase.firestore.FieldValue.arrayUnion({ elementID: "inviteToast", timestamp: new Date() }) });
            // Track with segment
            analytics.track("Element Viewed", { elementID: "inviteToast" });
        }
    }

</script>
<script>
    //Disable webflow form submissions
    Webflow.push(function () {
        $('form').submit(function () {
            return false;
        });
    });
</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackSubmitButton.addEventListener("click", storeFeedback);
        saveReferralCodeButton.addEventListener("click", function () {
            saveRefCodeLoadingDiv.style.display = 'flex';
            saveReferralCodeButton.style.display = 'none';
            const inputCode = referralCodeInput.value;
            connectReferralUsers(inputCode);
        });
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
        closeMeasurementsToastButton.addEventListener("click", function () { triggerMeasurementsToastClose.click(); });
        closeNewPriceToastButton.addEventListener("click", function () { triggerNewPriceToastClose.click(); });
        closeInviteToastButton.addEventListener("click", function () { triggerInviteToastClose.click(); });
        closeLongerPeriodToastButton.addEventListener("click", function () { triggerLongerPeriodToastClose.click(); });
        shareCodeButton.addEventListener('click', shareCode);
        sharePersonalLinkButton.addEventListener('click', shareCode);
    });

    function shareCode() {
        const code = user.referralData.referralCode;
        const text = `Hej, jag vill tipsa om Mai för att rensa ur garderoben. Mai är en tjänst som hjälper dig att sälja dina kläder på ett enkelt sätt. Man tar bilder på sina plagg, sedan sköter Mai resten, såsom värdering, publicering på plattformar, kontakt med köpare och frakt när det blir sålt. Man får själv behålla 80% av slutpriset, och blir det inte sålt kostar det ingenting.

Som en uppmuntran till att komma igång ger Mai dig 100kr i välkomstgåva, när du registrerar dig med min kod ${code}.

Läs mer och registrera dig här:`
        if (navigator.share) {
            navigator.share({
                text: text,
                url: `https://maiapp.se/?invite=${code}`
            }).then(() => { console.log('Thanks for sharing!'); }).catch(console.error);
        } else {
            console.log("Browser doesn't support navigator.share => Copy to clipboard!");
            const shareText = text + "\n" + `https://maiapp.se/?invite=${code}`;
            navigator.clipboard.writeText(shareText);
            linkCopiedBanner.style.display = 'flex';
            setTimeout(function () { linkCopiedBanner.style.display = 'none'; }, 1500);
        }
    }

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
</script>