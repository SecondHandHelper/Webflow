<script>
    var userId;
    var email;
    var phone;
</script>
<script>
    async function main() {
        userId = authUser.uid;
        email = authUser.email;
        phone = authUser.phoneNumber;
        emailVerified = authUser.emailVerified;
        updateIC(userId, email, phone);
        askForAdditionalUserDetails(userId);

        emptyListsInnerHTML();
        loadSoldByOthers(userId);
        //For testing purposes only - To see what a certain user sees
        if (userId === "3OkW5av20HP8ScpUDS8ip9fBEZr1" && window.location.origin.includes("shh-test")) {
            userId = "3OkW5av20HP8ScpUDS8ip9fBEZr1";
        }

        buildCardLists(userId);
        loadInfoRequests(userId);
        showReferralSection();
        showAccountInfo();

        await updateFirestoreUserDocument(authUser.uid, email, phone);
        if (!emailVerified && email) { window.location.replace('./user-management?mode=sendEmailVerification'); }
        // Create refCode
        if (user.addressFirstName && user.addressLastName && !user?.referralData?.referralCode) { createReferralCode(); }

        attribution();
    }

    function attribution(){
        ///// TESTING COOKIES
        const a = {}; // attribution
        const campaignID = checkCookie("utc_campaign");
        const adID = checkCookie("utc_content");
        if (campaignID) { a["campaignID"] = campaignID; }
        if (adID) { a["adID"] = adID; }
        storeAttribution(a, authUser.uid);
    }

    function storeAttribution(a, uid) {
        let fields = {};
        if (a.campaignID) { fields["attribution.campaignID"] = a.campaignID; }
        if (a.adID) { fields["attribution.adID"] = a.adID; }
        if (Object.keys(fields).length > 0) {
            db.collection('users').doc(uid).update(fields).catch((error) => {
                console.log("Error storing attribution:", fields, error);
            });
        }
    }

    function showAccountInfo() {
        let identifier;
        if (authUser.phoneNumber) {
            identifier = authUser.phoneNumber;
        } else if (authUser.email) {
            identifier = authUser.email;
        }
        if (identifier) {
            accountInfoText.innerHTML = `Inloggad med ${identifier}`;
            accountInfoText.style.display = 'block';
        }
    }
</script>
<script>
    //Disable webflow form submissions
    Webflow.push(function () {
        $('form').submit(function () {
            return false;
        });
    });
</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackSubmitButton.addEventListener("click", storeFeedback);
        saveReferralCodeButton.addEventListener("click", connectReferralUsers);
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
        closeMeasurementsToastButton.addEventListener("click", function () { triggerMeasurementsToastClose.click(); });
        closeNewPriceToastButton.addEventListener("click", function () { triggerNewPriceToastClose.click(); });
    });

    shareCodeButton.addEventListener('click', event => {
        const code = user.referralData.referralCode;
        const text = `Hej! Jag vill bjuda in dig till Mai. Använd min kod ${code} när du skapat ett konto och få 100 kr i välkomstgåva när du säljer ditt första plagg.`
        if (navigator.share) {
            navigator.share({
                text: text,
                url: 'https://maiapp.se'
            }).then(() => { console.log('Thanks for sharing!'); }).catch(console.error);
        } else {
            // fallback
            console.log("Browser doesn't support navigator.share => Copy to clipboard!");
            const shareText = text + "\nmaiapp.se"
            navigator.clipboard.writeText(shareText);
            linkCopiedText.style.display = 'flex';
            shareCodeButton.style.display = 'none';
        }
    });

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
</script>