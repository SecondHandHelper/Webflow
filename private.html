<script>
    var userId;
    var email;
    var phone;
</script>
<script>
    async function main() {
        if (authUser) {
            userId = authUser.uid;
            email = authUser.email;
            phone = authUser.phoneNumber;
            emailVerified = authUser.emailVerified;
            await updateFirestoreUserDocument(authUser.uid, email, phone); //Important that this happen first, since many other functions depend on an existing user document
            updateIC(userId, email, phone);
            askForAdditionalUserDetails(userId);
            loadSoldByOthers(userId);

            //For testing purposes only - To see what a certain user sees
            if (userId === "3OkW5av20HP8ScpUDS8ip9fBEZr1" && window.location.origin.includes("shh-test")) {
                userId = "3OkW5av20HP8ScpUDS8ip9fBEZr1";
            }
            const items = await getItems(userId);

            // If user has items since before, they'll add the shipping method from this page. If not, they'll add it when they add their first item
            if (items.size > 0 && !user?.preferences?.shippingMethod) window.location.replace('./choose-shipping-method');

            showNpsSurvey(items);
            showInviteToast(items);
            loadItemCards(items);
            loadInfoRequests(userId);
            showOrderBagsSection();
            showReferralSection();
            showAccountInfo();

            if (!emailVerified && email) {
                let res = getCookie('viewedVerifyEmailDiv');
                viewedVerifyEmailDiv = res === 'true' ? true : false;
                if (!viewedVerifyEmailDiv) {
                    window.location.replace('./user-management?mode=sendEmailVerification');
                }
            }
            // Create refCode
            if (user && user.addressFirstName && user.addressLastName && !user?.referralData?.referralCode) { createReferralCode(); }
        }
    }
</script>
<script>
    //Disable webflow form submissions
    Webflow.push(function () {
        $('form').submit(function () {
            return false;
        });
    });
</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackSubmitButton.addEventListener("click", storeFeedback);
        saveReferralCodeButton.addEventListener("click", function () {
            saveRefCodeLoadingDiv.style.display = 'flex';
            saveReferralCodeButton.style.display = 'none';
            const inputCode = referralCodeInput.value;
            connectReferralUsers(inputCode);
        });
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
        closeMeasurementsToastButton.addEventListener("click", function () { triggerMeasurementsToastClose.click(); });
        closeNewPriceToastButton.addEventListener("click", function () { triggerNewPriceToastClose.click(); });
        closeInviteToastButton.addEventListener("click", function () { triggerInviteToastClose.click(); });
        closeServicePointToastButton.addEventListener("click", function () { triggerServicePointToastClose.click(); });
        confirmServicePointButton.addEventListener("click", function () {
            document.getElementById('feedbackFormTitle').innerHTML = '';
            triggerServicePointToastClose.click();
            triggerFeedbackFormOpen.click();
        });
        closeLongerPeriodToastButton.addEventListener("click", function () { triggerLongerPeriodToastClose.click(); });
        shareCodeButton.addEventListener('click', shareCode);
        sharePersonalLinkButton.addEventListener('click', shareCode);
    });

    function shareCode() {
        const code = user.referralData.referralCode;
        const text = `Hej, jag vill tipsa om Mai för att rensa ur garderoben. Mai är en tjänst som hjälper dig att sälja dina kläder på ett enkelt sätt. Man tar bilder på sina plagg, sedan sköter Mai resten, såsom värdering, publicering på plattformar, kontakt med köpare och frakt när det blir sålt. Man får själv behålla 80% av slutpriset, och blir det inte sålt kostar det ingenting.

Som en uppmuntran till att komma igång ger Mai dig 100kr i välkomstgåva, när du registrerar dig med min kod ${code}.

Läs mer och registrera dig här:`
        if (navigator.share) {
            navigator.share({
                text: text,
                url: `https://maiapp.se/?invite=${code}`
            }).then(() => { console.log('Thanks for sharing!'); }).catch(console.error);
        } else {
            console.log("Browser doesn't support navigator.share => Copy to clipboard!");
            const shareText = text + "\n" + `https://maiapp.se/?invite=${code}`;
            navigator.clipboard.writeText(shareText);
            linkCopiedBanner.style.display = 'flex';
            setTimeout(function () { linkCopiedBanner.style.display = 'none'; }, 1500);
        }
    }

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
</script>