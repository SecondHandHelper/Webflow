<script>
    var userId;
    var email;
    var phone;
</script>
<script>
      authUser.whenSet(privateMain);
      async function privateMain() {
        if (authUser.current) {
          console.log("authUser.current: " + authUser.current);
            userId = authUser.current.uid;
            email = authUser.current.email || sessionStorage.getItem("email");
            phone = authUser.current.phoneNumber || sessionStorage.getItem("phoneNumber");
            emailVerified = authUser.current.emailVerified;
            updateIC(userId, email, phone);
            askForAdditionalUserDetails(userId);
            loadSoldByOthers(userId);
            setPreferredLogInMethodCookie(authUser.current.providerData[0].providerId);

            //For testing purposes only - To see what a certain user sees
            if (userId === "3OkW5av20HP8ScpUDS8ip9fBEZr1" && window.location.origin.includes("shh-test")) {
                userId = "3OkW5av20HP8ScpUDS8ip9fBEZr1";
            }
            const items = await getItems(userId);

            // If user has items since before, they'll add the shipping method from this page. If not, they'll add it when they add their first item
            if (items.size > 0 && !user.current?.preferences?.shippingMethod) window.location.replace('./choose-shipping-method');

            showNpsSurvey(items);
            showInviteToast(items);
            loadItemCards(items);
            loadInfoRequests(userId);
            showOrderBagsSection();
            showReferralSection();
            showAccountInfo();

            if (!emailVerified && email) {
                let res = getCookie('viewedVerifyEmailDiv');
                viewedVerifyEmailDiv = res === 'true';
                if (!viewedVerifyEmailDiv) {
                    window.location.replace('./user-management?mode=sendEmailVerification');
                }
            }
            // Create refCode
            if (user.current && user.current.addressFirstName && user.current.addressLastName && !user.current?.referralData?.referralCode) { createReferralCode(); }
        }
    }

    async function showNpsSurvey(items) {
        if (!user) { return; }
        const nowDate = new Date();
        let daysSinceFirstPublished = 0;
        let daysSinceLastPublished = 0;

        // Last viewed
        const x = user.current?.elementViews ? user.current.elementViews.reverse().find(e => e.elementID === 'npsSurvey') : null;
        const surveyLastViewed = x ? x.timestamp.toDate() : null;
        const daysSinceSurveyLastViewed = surveyLastViewed ? Math.floor((nowDate.getTime() - surveyLastViewed.getTime()) / (1000 * 3600 * 24)) : null;

        if (items) {
            items.forEach((doc) => {
                const i = doc.data();
                if (i.publishedDate && !i.archived) {
                    const publishedDate = new Date(i.publishedDate);
                    const daysDiff = Math.floor((nowDate.getTime() - publishedDate.getTime()) / (1000 * 3600 * 24));
                    if (daysDiff > daysSinceFirstPublished) {
                        daysSinceFirstPublished = daysDiff;
                    }
                    if (daysDiff < daysSinceLastPublished || (daysSinceLastPublished === 0 && daysDiff > 0)) {
                        daysSinceLastPublished = daysDiff;
                    }
                }
            });
        }

        //console.log("IF all true -> Show NPS: ", `daysSinceFirstPublished(${daysSinceFirstPublished}) >= 25 && daysSinceLastPublished(${daysSinceLastPublished}) <= 60 && (!surveyLastViewed(${surveyLastViewed}) || daysSinceSurveyLastViewed(${daysSinceSurveyLastViewed}) > 90)`);
        if (daysSinceFirstPublished >= 25 && daysSinceLastPublished <= 60 && (!surveyLastViewed || daysSinceSurveyLastViewed > 90) && !document.referrer.includes('feedback-nps')) {
            window.location.href = window.location.origin + "/feedback-nps";
        }
    }
</script>
<script>
    //Disable webflow form submissions
    Webflow.push(function () {
        $('form').submit(function () {
            return false;
        });
    });
</script>
<script>
    window.addEventListener('load', function () {
        signoutButton.addEventListener('click', signOut);
        bookPickupForm.addEventListener("submit", bookPickup);
        closePickupToastIcon.addEventListener("click", closePickupToast);
        closeFeedbackFormButton.addEventListener("click", closeFeedbackForm);
        happySmileyButton.addEventListener("click", function () { setHappinessRate(3); }, false);
        neutralSmileyButton.addEventListener("click", function () { setHappinessRate(2); }, false);
        angrySmileyButton.addEventListener("click", function () { setHappinessRate(1); }, false);
        feedbackSubmitButton.addEventListener("click", storeFeedback);
        saveReferralCodeButton.addEventListener("click", function () {
            saveRefCodeLoadingDiv.style.display = 'flex';
            saveReferralCodeButton.style.display = 'none';
            const inputCode = referralCodeInput.value;
            connectReferralUsers(inputCode);
        });
        referralCodeInput.addEventListener("input", function () { saveReferralCodeButton.style.display = 'inline-block'; });
        closeMeasurementsToastButton.addEventListener("click", function () { triggerMeasurementsToastClose.click(); });
        closeNewPriceToastButton.addEventListener("click", function () { triggerNewPriceToastClose.click(); });
        closeInviteToastButton.addEventListener("click", function () { triggerInviteToastClose.click(); });
        closeServicePointToastButton.addEventListener("click", function () { triggerServicePointToastClose.click(); });
        confirmServicePointButton.addEventListener("click", function () {
            document.getElementById('feedbackFormTitle').innerHTML = '';
            triggerServicePointToastClose.click();
            triggerFeedbackFormOpen.click();
        });
        closeLongerPeriodToastButton.addEventListener("click", function () { triggerLongerPeriodToastClose.click(); });
        shareCodeButton.addEventListener('click', shareCode);
        sharePersonalLinkButton.addEventListener('click', shareCode);
    });

    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();

</script>
