<script>
    async function fillForm(itemId) {
      try {
        const userId = authUser.current.uid;
        const item = await firebase.app().functions("europe-west1").httpsCallable('getItem')({itemId})
        const data = item.data;
        if (userId === data.user || userId === '3OkW5av20HP8ScpUDS8ip9fBEZr1') {
          console.log("Item data:", data);
          const sex = data.sex;
          const size = data.size;
          const material = data.material;
          const brand = data.brand;
          const model = data.model;
          let originalPrice = data.originalPrice;
          if (originalPrice <= 0) {
            originalPrice = null;
          }
          const age = data.age;
          const condition = data.condition;
          const defects = data.defects;
          const defectDescription = data.defectDescription;
          const noSmoke = data.noSmoke;
          const noAnimals = data.noAnimals;
          const userComment = data.userComment;
          const infoRequests = data.infoRequests;
          const images = data.images;
          const status = data.status;
          let category = "";
          if (data.category) {
            category = data.category;
          }

          // Populate images
          function hideSiblings(x, url) {
            document.getElementById(`${x}Preview`).style.backgroundImage = `url('${url}')`;
            siblings = document.getElementById(x).parentNode.parentNode.childNodes;
            for (var i = 0; i < siblings.length; i++) {
              if (siblings[i].className.includes("success-state")) {
                siblings[i].style.display = 'block';
              } else {
                siblings[i].style.display = 'none';
              }
            }
          }

          for (const x in images) {
            const possibleElmts = ["brandTagImage", "materialTagImage", "defectImage", "productImage", "extraImage"];
            const url = images[`${x}Small`] || images[`${x}Medium`] || images[`${x}Large`] || images[x];
            if (possibleElmts.includes(x)) {
              hideSiblings(x, url);
            }
          }
          // Special case for frontImage where we want to show the enhancedFrontImage
          const frontImageUrl = images[`enhancedFrontImageSmall`] || images[`enhancedFrontImageMedium`] || images[`enhancedFrontImageLarge`] || images['enhancedFrontImage'];
          if (frontImageUrl) {
            hideSiblings('frontImage', frontImageUrl);
          }

          // Populate text input fields
          pageTitle.innerHTML = brand;
          pageSubTitle.innerHTML = category;
          itemSize.setAttribute('value', size);
          itemBrand.setAttribute('value', brand);
          itemMaterial.setAttribute('value', material);
          itemModel.setAttribute('value', model);
          itemOriginalPrice.setAttribute('value', originalPrice);
          itemUserComment.value = userComment; //Textarea
          itemDefectDescription.value = defectDescription; //Textarea

          // Populate select fields
          let options = itemAge.options;
          for (let i = 0; i < options.length; i++) {
            if (age == options[i].attributes.value.value) {
              itemAge.selectedIndex = i;
              if (age != "") {
                itemAge.style.color = "#333";
              }
            }
          }
          options = itemCondition.options;
          for (let i = 0; i < options.length; i++) {
            if (condition == options[i].innerText) {
              itemCondition.selectedIndex = i;
              itemCondition.style.color = "#333";
              if (options[i].innerText == "Anv채nd, tecken p책 slitage") {
                defectInfoDiv.style.display = 'block';
              }
            }
          }

          // Populate checkboxes and readio-buttons is harder to do with Webflow, so not allowing users to change defects right now

          // If "info request" for images exist, show the directions
          if (infoRequests?.images?.status === "Active" && infoRequests?.images?.description) {
            photoDirectionsText.style.display = 'none';
            infoRequestImagesText.innerHTML = infoRequests.images.description;
            infoRequestImagesDiv.style.display = 'flex';
          }

          // Show form
          updateItemFormDiv.style.display = "block";
          pageTitleDiv.style.display = "flex";
          loadingDiv.style.display = "none";
        }
      } catch (error) {
          errorHandler.report(error);
          console.log("Error getting item document:", error);
      }
    }

    async function saveChanges() {
        saveChangesButtonText.style.color = "#e2dede";
        console.log("changedImages: ", changedImages);
        await updateItem(params.id, changedImages);
    }

    // EVENT LISTENERS
    let imageElementIds = ['frontImage', 'brandTagImage', 'materialTagImage', 'productImage','defectImage','extraImage'];
    imageElementIds.forEach(function (id) {
        let elemUpload = document.getElementById(id);
        let elemPreviewUploading = document.getElementById(`${id}PreviewUploading`);
        let elemPreview = document.getElementById(`${id}Preview`);
        elemUpload.addEventListener("change", function () {
            let input = this.files[0];
            if (input) {
                let src = URL.createObjectURL(input);
                elemPreviewUploading.style.backgroundImage = `url('${src}')`;
                elemPreview.style.backgroundImage = `url('${src}')`;
            }
        });
    });
    document.getElementById('frontImage').addEventListener('change', async function () {
      let input = this.files[0];
      if (input) {
        document.getElementById('loadingFrontImageIcon').style.display = 'inline-block';
        document.getElementById('deleteFrontImageIcon').style.display = 'none';
        const base64Image = await createEnhancedImage(input);
        const enhancedImage = await uploadEnhancedFrontImage(base64Image);
        document.getElementById('frontImagePreviewUploading').style.backgroundImage = `url('${enhancedImage}')`;
        document.getElementById('frontImagePreview').style.backgroundImage = `url('${enhancedImage}')`;
        document.getElementById('loadingFrontImageIcon').style.display = 'none';
        document.getElementById('deleteFrontImageIcon').style.display = 'inline-block';
      }
    });

    let changedImages = [];
    let elementsArray = document.querySelectorAll("input");
    elementsArray.forEach(function (elem) {
        elem.addEventListener("input", function () {
            saveChangesButtonText.style.color = "#c24700";
            saveChangesButtonText.innerHTML = "Spara";
            if (elem.id.includes("Image")) {
                changedImages.push(elem.id);
            }
        });
    });

    itemCondition.onchange = function () {
        let input = this.value;
        if (input == "Anv채nd, tecken p책 slitage") {
            defectInfoDiv.style.display = 'block';
            itemCondition.style.color = "#333";
        } else if (input == "") {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#929292";
        } else {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#333";
        }
    };

    itemAge.onchange = function () {
        let input = this.value;
        if (input != "") {
            itemAge.style.color = "#333";
        } else {
            itemAge.style.color = "#929292";
        }
    };

    saveChangesButton.addEventListener('click', saveChanges);
    user.whenSet(async () => fillForm(params.id));
    autocomplete(document.getElementById("itemBrand"), brands); // Enable autocomplete
</script>
