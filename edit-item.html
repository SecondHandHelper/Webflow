<script>
    $(document).ready(function () {
        $(".goback").click(function () {
            window.history.back();
        });
    });
</script>
<script>
    // Get params
    var queryStr = window.location.search;
    var paramPairs = queryStr.substr(1).split('&');
    var params = {};
    for (var i = 0; i < paramPairs.length; i++) {
        var parts = paramPairs[i].split('=');
        params[parts[0]] = parts[1];
    }
</script>
<script>
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log('UID: ' + user.uid);
            userId = user.uid;
        } else {
            console.log('No user is logged in');
            window.location.href = window.location.origin;
        }
    });
</script>
<script>
    function fillForm(itemId) {
        db.collection("items").doc(itemId)
            .get().then((doc) => {
                if (doc.exists) {
                    data = doc.data();
                    if (userId === data.user) {
                        console.log("Item data:", doc.data());
                        const sex = data.sex;
                        const size = data.size;
                        const material = data.material;
                        const brand = data.brand;
                        const model = data.model;
                        let originalPrice = data.originalPrice;
                        if (originalPrice <= 0) { originalPrice = null; }
                        const age = data.age;
                        const condition = data.condition;
                        const defects = data.defects;
                        const defectDescription = data.defectDescription;
                        const noSmoke = data.noSmoke;
                        const noAnimals = data.noAnimals;
                        const userComment = data.userComment;
                        const infoRequests = data.infoRequests;
                        const images = data.images;
                        let frontImg = images.frontImage;
                        if (images.frontImageSmall) {
                            frontImg = images.frontImageSmall;
                        }
                        const status = data.status;
                        let category = "";
                        if (data.category) { category = data.category; }

                        // Populate images
                        function hideSiblings(x, url) {
                            document.getElementById(`${x}Preview`).style.backgroundImage = `url('${url}')`;
                            siblings = document.getElementById(x).parentNode.parentNode.childNodes;
                            for (var i = 0; i < siblings.length; i++) {
                                if (siblings[i].className.includes("success-state")) {
                                    siblings[i].style.display = 'block';
                                } else {
                                    siblings[i].style.display = 'none';
                                }
                            }
                        }
                        for (const x in images) {
                            const possibleElmts = ["frontImage", "brandTagImage", "materialTagImage", "defectImage", "productImage", "extraImage"];
                            if (possibleElmts.includes(x)) {
                                hideSiblings(x, images[x]);
                            }
                        }

                        // Populate text input fields
                        pageTitle.innerHTML = brand;
                        pageSubTitle.innerHTML = category;
                        itemSize.setAttribute('value', size);
                        itemBrand.setAttribute('value', brand);
                        itemMaterial.setAttribute('value', material);
                        itemModel.setAttribute('value', model);
                        itemOriginalPrice.setAttribute('value', originalPrice);
                        itemUserComment.value = userComment; //Textarea
                        itemDefectDescription.value = defectDescription; //Textarea

                        // Populate select fields
                        let options = itemAge.options;
                        for (let i = 0; i < options.length; i++) {
                            if (age == options[i].attributes.value.value) {
                                itemAge.selectedIndex = i;
                                if (age != "") {
                                    itemAge.style.color = "#333";
                                }
                            }
                        }
                        options = itemCondition.options;
                        for (let i = 0; i < options.length; i++) {
                            if (condition == options[i].innerText) {
                                itemCondition.selectedIndex = i;
                                itemCondition.style.color = "#333";
                                if (options[i].innerText == "Anv채nd, tecken p책 slitage") {
                                    defectInfoDiv.style.display = 'block';
                                }
                            }
                        }

                        // Populate checkboxes and readio-buttons is harder to do with Webflow, so not allowing users to change defects right now

                        // If "info request" for images exist, show the directions
                        if (infoRequests?.images?.status === "Active" && infoRequests?.images?.description) {
                            photoDirectionsText.style.display = 'none';
                            infoRequestImagesText.innerHTML = infoRequests.images.description;
                            infoRequestImagesDiv.style.display = 'flex';
                        }

                        // Show form
                        updateItemFormDiv.style.display = "block";
                        pageTitleDiv.style.display = "flex";
                        loadingDiv.style.display = "none";
                    }
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting item document:", error);
            });
    }

    async function saveChanges() {
        saveChangesButtonText.style.color = "#e2dede";
        console.log("changedImages: ", changedImages);
        updateItem(params.id, changedImages);
    }

    // EVENT LISTENERS
    let imageElementIds = ['frontImage', 'brandTagImage', 'materialTagImage', 'productImage','defectImage','extraImage'];
    imageElementIds.forEach(function (id) {
        let elemUpload = document.getElementById(id);
        let elemPreviewUploading = document.getElementById(`${id}PreviewUploading`);
        let elemPreview = document.getElementById(`${id}Preview`);
        elemUpload.addEventListener("change", function () {
            let input = this.files[0];
            if (input) {
                let src = URL.createObjectURL(input);
                elemPreviewUploading.style.backgroundImage = `url('${src}')`;
                elemPreview.style.backgroundImage = `url('${src}')`;
            }
        });
    });

    let changedImages = [];
    let elementsArray = document.querySelectorAll("input");
    elementsArray.forEach(function (elem) {
        elem.addEventListener("input", function () {
            saveChangesButtonText.style.color = "#c24700";
            saveChangesButtonText.innerHTML = "Spara";
            if (elem.id.includes("Image")) {
                changedImages.push(elem.id);
            }
        });
    });

    itemCondition.onchange = function () {
        let input = this.value;
        if (input == "Anv채nd, tecken p책 slitage") {
            defectInfoDiv.style.display = 'block';
            itemCondition.style.color = "#333";
        } else if (input == "") {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#929292";
        } else {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#333";
        }
    };

    itemAge.onchange = function () {
        let input = this.value;
        if (input != "") {
            itemAge.style.color = "#333";
        } else {
            itemAge.style.color = "#929292";
        }
    };

    saveChangesButton.addEventListener('click', saveChanges);
    fillForm(params.id);  // Fill form
    autocomplete(document.getElementById("itemBrand"), brands); // Enable autocomplete
</script>