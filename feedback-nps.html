<script>
    var npsId;
    var npsScore;

    async function addNpsScore() {
        let score = 11;
        var radioButtons = document.getElementsByName("nps");
        for (var x = 0; x < radioButtons.length; x++) {
            if (radioButtons[x].checked) {
                score = parseInt(radioButtons[x].value); // 0-10
                npsScore = score;
            }
        }

        // Validation
        if (!(score >= 0 && score <= 10)) {
            npsErrorMessage.style.display = 'block';
            return;
        }
        if (!authUser) {
            npsErrorMessage.innerHTML = 'Du måste vara inloggad för att svara';
            npsErrorMessage.style.display = 'block';
            return;
        }

        // Store score
        const docRef = await db.collection("nps").add({ score, answeredAt: new Date(), user: authUser.uid });
        npsId = docRef.id;
        console.log(`Score '${score}' stored in DB with npsId: `, npsId);

        // Show follow up question
        if (score >= 0 && score <= 6) {
            followUpQuestion.innerHTML = 'Tack för feedbacken! Vilka förändringar skulle Mai behöva göra för att få ett högre betyg?';
        }
        if (score >= 7 && score <= 8) {
            followUpQuestion.innerHTML = 'Tack för feedbacken! Vilka förändringar skulle göra Mai bättre?';
        }
        if (score >= 9 && score <= 10) {
            followUpQuestion.innerHTML = 'Kul att du gillar det! Vad är Mai riktigt bra på?';
        }

        triggerShowFollowUpQuestion.click();
    }

    async function addFollowUp() {
        const question = followUpQuestion.innerHTML;
        const answer = followUpAnswer.value;

        // Update latest NPS document with question and answer
        if (answer) { await db.collection('nps').doc(npsId).update({ followUpQuestion: question, followUpAnswer: answer }); }
    }

    async function main() {
        // Store elementViews to be able to hinder it to show again
        db.collection('users').doc(authUser.uid).update({ elementViews: firebase.firestore.FieldValue.arrayUnion({ elementID: "npsSurvey", timestamp: new Date() }) });
        // Track with segment
        analytics.track("Element Viewed", { elementID: "npsSurvey" });
    }


    npsSubmitButton.addEventListener("click", addNpsScore);
    followUpSubmitButton.addEventListener("click", async function () {
        await addFollowUp();
        // Show thank you div
        if (user?.referralData?.referralCode && npsScore >= 9 && npsScore <= 10){
            referralCodeText.innerHTML = user.referralData.referralCode;
            thankYouNoPromotorDiv.style.display = 'none';
            thankYouPromotorDiv.style.display = 'block';
            analytics.track("Element Viewed", { elementID: "thankYouPromotorDiv" });
        }
        triggerShowThankYou.click();
    });
    closeThankYouButton.addEventListener("click", function () {
        if (authUser) { window.location.href = window.location.origin + "/private"; }
        else { window.location.href = window.location.origin; }
    });
    sharePersonalLinkFromNpsButton.addEventListener('click', shareCode);
</script>