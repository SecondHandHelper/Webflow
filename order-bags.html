<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Order bags</title>
  <style>
    #orderBagsConfirmation {display: none}
    #orderBagsSpinner {display: none}
    #closeOrderBagsSpinner {display: none}
    #orderBagsError { display: none }
  </style>
</head>
<body>
<div id="orderForm">
  <div style="margin-bottom:10px;">
    <span id="minusSmall" style="padding:10px 5px; cursor: pointer">-</span><input style="color: lightgray;" id="numSmall" value="0" width="40px"><span style="padding:10px 5px; cursor: pointer" id="plusSmall">+</span>
  </div><div style="margin-bottom:10px;">
    <span id="minusMedium" style="padding:10px 5px; cursor: pointer">-</span><input style="color: lightgray;" id="numMedium" value="0" width="40px"><span style="padding:10px 5px; cursor: pointer" id="plusMedium">+</span>
  </div><div>
    <span id="minusLarge" style="padding:10px 5px; cursor: pointer">-</span><input style="color: lightgray;" id="numLarge" value="0" width="40px"><span style="padding:10px 5px; cursor: pointer" id="plusLarge">+</span>
  </div>
  <div id="orderBagsError"></div>
  <div style="margin-top: 20px">
    <button type="button" id="orderBags" disabled><div id="orderBagsButtonText">Beställ 0 påsar gratis</div></button>
  </div>
  <div id="orderBagsSpinner">Loading ...</div>
</div>
<div id="orderBagsConfirmation">
  <div style="margin-top: 20px">
    <div>
      <span id="bagsOrdered">0 påsar</span> på väg!
    </div>
    <button style="margin-top: 10px" type="button">Ok</button>
    <div id="closeOrderBagsSpinner">Loading ...</div>
  </div>
</div>
</body>
<script>
  var maxNumBags = 10;
  async function getMaxNumBags() {
    const maxBags = await firebase.app().functions("europe-west1").httpsCallable('maxNumBags')();
    if (maxBags?.data) {
      if (maxBags.data?.errorCode === 'unfulfilled-order') {
        document.getElementById('orderBagsError').style.display = 'block';
        document.getElementById('orderBagsError').innerText = 'Du har redan en aktiv beställning som är på väg. Vänta tills den kommer fram innan du gör en ny beställning.';
        validateAndDecrease(document.getElementById('numSmall'));
        validateAndDecrease(document.getElementById('numMedium'));
        validateAndDecrease(document.getElementById('numLarge'));
      }
      if (maxBags.data.maxOrderBags === 0) {
        document.getElementById('orderBagsError').style.display = 'block';
        document.getElementById('orderBagsError').innerText = 'Du har just nu inga varor till försäljning och kan därför inte beställa några påsar.';
        validateAndDecrease(document.getElementById('numSmall'));
        validateAndDecrease(document.getElementById('numMedium'));
        validateAndDecrease(document.getElementById('numLarge'));
      }
      maxNumBags = Math.min(maxBags.data.maxOrderBags, maxNumBags);
    }
  }
  getMaxNumBags();

  function validateAndDecrease(input) {
    input.value = Math.max(+input.value - 1, 0);
    input.style.color = +input.value === 0 ? '#9c9595' : '#000';
    updateOrderButton();
  }

  function numOrdered() {
    return +document.getElementById('numSmall').value + +document.getElementById('numMedium').value +
      +document.getElementById('numLarge').value
  }

  function updateOrderButton() {
    document.getElementById('orderBags').innerText = `Beställ ${numOrdered()} ${bagOrBags()} gratis`;
  }

  function bagOrBags() {
    return numOrdered() === 1 ? 'påse' : 'påsar';
  }

  function validateAndIncrease(input) {
    if (numOrdered() >= maxNumBags) {
      return
    }
    input.value = Math.min(+input.value + 1, 10);
    updateOrderButton();
    if (+input.value === 1) {
      input.style.color = 'black';
    }
  }
  function addInputComponentEventListeners(minusElm, plusElm, inputElm) {
    document.getElementById(minusElm).addEventListener("click", function() {
      validateAndDecrease(document.getElementById(inputElm));
    });
    document.getElementById(plusElm).addEventListener("click", function() {
      validateAndIncrease(document.getElementById(inputElm));
    })
  }
  addInputComponentEventListeners('minusSmall', 'plusSmall', 'numSmall');
  addInputComponentEventListeners('minusMedium', 'plusMedium', 'numMedium');
  addInputComponentEventListeners('minusLarge', 'plusLarge', 'numLarge');
  document.getElementById('orderBags').addEventListener('click', async function() {
    if (numOrdered() === 0) {
      return;
    }
    document.getElementById('orderBagsError').style.display = 'none';
    document.getElementById('orderBags').style.display = 'none';
    document.getElementById('orderBagsSpinner').style.display = 'flex';
    const numSmallBags = +document.getElementById('numSmall').value;
    const numMediumBags = +document.getElementById('numMedium').value;
    const numLargeBags = +document.getElementById('numLarge').value;
    try {
      await firebase.app().functions("europe-west1").httpsCallable('orderSellerBags')({numLargeBags, numSmallBags, numMediumBags});
      document.getElementById('bagsOrdered').innerText = `${numOrdered()} ${bagOrBags()} på väg!`;
    } catch (e) {
      document.getElementById('orderBagsError').style.display = 'block';
      document.getElementById('orderBagsError').innerText = 'Något gick fel vid beställningen. Försök igen och kontakta oss om det fortfarande inte fungerar.';
      document.getElementById('orderBags').style.display = 'flex';
      document.getElementById('orderBagsSpinner').style.display = 'none';
      return;
    }
    document.getElementById('orderBagsForm').style.display = 'none';
    document.getElementById('orderBagsConfirmation').style.display = 'block';
  });
  document.getElementById('closeOrderBagsConfirmationButton').addEventListener("click", function () {
    document.getElementById('closeOrderBagsConfirmationButton').style.display = 'none';
    document.getElementById('closeOrderBagsSpinner').style.display = 'flex';
  });
</script>
</html>
