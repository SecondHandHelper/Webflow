<script>
  let fullPersonId = ''
  let address = {}
  let pageHeader = document.getElementById('pageTitleText')

  let saveLoadingSpinner = document.getElementById('saveLoadingSpinner')
  let settingsContainer = document.getElementById('settingsContainer')


  async function getUserInfo(onUpdate) {
    try {
      const response = await firebase.app().functions("europe-west1").httpsCallable('getUserInfo')();
      await displayPersonalId(response.data.personalId);
      address = response.data
      const shippingMethod = response.data.preferences.shippingMethod || null;

      addressDisplay.innerHTML = address.addressStreetAddress ? `${address.addressStreetAddress} <br/> ${address.addressPostalCode} ${address.addressCity}` : '-';
      swishNumberDisplay.innerHTML = response.data.swishPayeeAlias || '-';
      phoneNumberDisplay.innerHTML = response.data.phoneNumber || '-';
      shippingPreferencesDisplay.innerHTML = shippingMethod || '-';
    } catch (e) {
      console.log('error fetching user data', e)
    } finally {
      if (!onUpdate) {
        loadingDiv.style.display = 'none'
        settingsContainer.style.display = 'block'
      }
    }
  }

  async function displayPersonalId(personId) {
    fullPersonId = personId || ''
    let personIdLastFour = '-'

    if (fullPersonId.length > 4) {
      personIdLastFour = fullPersonId.substring(fullPersonId.length - 4);
      personalIdDisplay.innerHTML = `XXXXXXXX-${personIdLastFour}`
      return
    }
    personalIdDisplay.innerHTML = personIdLastFour
  }

  async function updateUserAddress() {
    try {
      loadOnSavePressed()
      await firebase.app().functions("europe-west1").httpsCallable(
        'updateFirebaseUser',
      )({...await getFormAddressFields()})
      await onUpdateComplete()
    } catch (e) {
      console.log('Error updating user', e)
    }
  }

  async function updateShippingPreference() {
    loadOnSavePressed()
    let shippingMethod = "";
    let radioButtons = document.getElementsByName('shippingMethodSettings');
    for (let x = 0; x < radioButtons.length; x++) {
      if (radioButtons[x].checked) {
        shippingMethod = radioButtons[x].value; // "Service point" or "Pickup"
      }
    }
    await firebase.app().functions("europe-west1").httpsCallable(
      'updateFirebaseUser',
    )({preferences: {shippingMethod}})
    await onUpdateComplete()
  }

  async function updateContactNumbers(isSwish) {
    try {
      loadOnSavePressed()
      await firebase.app().functions("europe-west1").httpsCallable(
        'updateFirebaseUser',
      )({...getCleanedNumber(isSwish)})
      await onUpdateComplete()
    } catch (e) {

    }
  }

  async function updateUserPersonId() {
    try {
      loadOnSavePressed()
      await firebase.app().functions("europe-west1").httpsCallable(
        'updateFirebaseUser',
      )({personalId: formatPersonalId(personalId.value.trim().replace(/\D/g, ''))})
      await onUpdateComplete()
    } catch (e) {
      console.log('Error updating user', e)
    }
  }

  async function onUpdateComplete() {
    await getUserInfo(true)
    saveButton.innerHTML = 'Sparat'
    saveButton.style.opacity = '0.6'
    saveButton.disabled = true
    saveLoadingSpinner.style.display = 'none'
    saveButtonContainer.style.display = 'block'
  }


  function getCleanedNumber(isSwish) {
    let input = isSwish ? swishNumber.value.trim() : phoneNumber.value.trim()
    return isSwish ? {swishPayeeAlias: formatPhoneNumber(input)} : {phoneNumber: formatPhoneNumber(input)}
  }

  function loadOnSavePressed() {
    document.getElementById('saveButtonContainer').style.display = 'none'
    saveLoadingSpinner.style.display = 'block'
  }

  function displayForm(divId, formId, newValue, headerText) {
    document.getElementById(formId).style.display = 'block'
    document.getElementById('updateContainer').style.display = 'block'
    document.getElementById('goBackDiv').style.display = 'none'
    document.getElementById('resetPageDiv').style.display = 'block'
    saveButton.style.display = 'block'
    settingsContainer.style.display = 'none'
    pageHeader.innerHTML = headerText
    pageHeader.value = headerText
    if (newValue) {
      if (newValue === personalId) {
        newValue.value = fullPersonId
        return
      }
      newValue.value = document.getElementById(divId).innerHTML.length > 2 ? document.getElementById(divId).innerHTML : ''
    }
  }

  function isValid(id) {
    return !!id.validity.valid && saveButton.innerHTML === 'Spara'
  }

  function isAllValid(ids) {
    let valid = true

    for (const id of ids) {
      if (!id.validity.valid) {
        valid = false
      }
    }
    return !!valid && saveButton.innerHTML === 'Spara'
  }

  function displayFieldLabel(id, show) {
    id.style.display = !!show ? 'inline-block' : 'none'
  }

  adressDiv.addEventListener("click", async function () {
    setFormAddressFields(response.data)
    displayForm('adressDiv', 'addressForm', null, 'Adress')
  })

  addressFirstName.addEventListener("input", function () {
    displayFieldLabel(firstNameText, addressFirstName.value)
  })
  addressLastName.addEventListener("input", function () {
    displayFieldLabel(lastNameText, addressLastName.value)
  })
  addressStreetAddress.addEventListener("input", function () {
    displayFieldLabel(streetAddressText, addressStreetAddress.value)
  })
  addressCO.addEventListener("input", function () {
    displayFieldLabel(addressCoText, addressCO.value)
  })
  addressPostalCode.addEventListener("input", function () {
    displayFieldLabel(postalCodeText, addressPostalCode.value)
  })
  addressCity.addEventListener("input", function () {
    displayFieldLabel(addressCityText, addressCity.value)
  })
  addressDoorCode.addEventListener("input", function () {
    displayFieldLabel(doorCodeText, addressDoorCode.value)
  })

  phoneDiv.addEventListener("click", function () {
    displayForm('phoneNumberDisplay', 'phoneForm', phoneNumber, 'Mobilnummer')
  })

  phoneNumber.addEventListener("input", function () {
    displayFieldLabel(phoneNumberText, phoneNumber.value)

    const error = phoneNumber.length !== 0 ? '' : 'Ogiltigt phonenummer';
    phoneNumber.setCustomValidity(error);
  })

  shippingPrefDiv.addEventListener("click", function () {
    displayForm('shippingPrefDiv', 'shippingPrefForm', null, 'Skicka plagg')
  })

  swishDiv.addEventListener("click", function () {
    displayForm('swishNumberDisplay', 'swishForm', swishNumber, 'Swish')
  })

  swishNumber.addEventListener("input", () => {
    displayFieldLabel(swishNumberText, swishNumber.value)

    const error = swishNumber.length !== 0 ? '' : 'Ogiltigt swishNumber';
    swishNumber.setCustomValidity(error);
  })

  personIdDiv.addEventListener("click", function () {
    displayForm('fullPersonId', 'personIdForm', personalId, 'Personnummer')
  })

  personalId.addEventListener("input", () => {
    displayFieldLabel(personalIdText, personalId.value)

    const error = isValidSwedishSsn(personalId.value) ? '' : 'Ogiltigt personnummer';
    personalId.setCustomValidity(error);
  })

  saveButton.addEventListener("click", async function () {
    switch (pageHeader.value) {
      case 'Adress':
        if (isAllValid([addressFirstName, addressLastName, addressCity, addressPostalCode, addressStreetAddress])) {
          await updateUserAddress()
        }
        addressFirstName.reportValidity()
        addressLastName.reportValidity()
        addressCity.reportValidity()
        addressPostalCode.reportValidity()
        addressStreetAddress.reportValidity()

        break
      case 'Skicka plagg':
        await updateShippingPreference()
        break
      case 'Personnummer':
        if (isValid(personalId)) {
          await updateUserPersonId()
        }
        personalId.reportValidity()
        break
      case 'Swish':
        if (isValid(swishNumber)) {
          await updateContactNumbers(true)
        }
        swishNumber.reportValidity()
        break
      case'Mobilnummer':
        if (isValid(phoneNumber)) {
          await updateContactNumbers()
        }
        phoneNumber.reportValidity()
        break
    }
  })

  resetPageButton.addEventListener("click", () => {
    const formIds = {
      'Adress': 'addressForm',
      'Mobilnummer': 'phoneForm',
      'Swish': 'swishForm',
      'Personnummer': 'personIdForm',
      'Skicka plagg': 'shippingPrefForm',
    }
    document.getElementById(formIds[pageHeader.value]).style.display = 'none'
    document.getElementById('updateContainer').style.display = 'none'
    document.getElementById('goBackDiv').style.display = 'block'
    document.getElementById('resetPageDiv').style.display = 'none'
    settingsContainer.style.display = 'block'
    saveButton.style.display = 'none'
    saveLoadingSpinner.style.display = 'none'
    pageHeader.innerHTML = 'Inställningar'
    pageHeader.value = 'Inställningar'
    saveButton.innerHTML = 'Spara'
    saveButton.style.opacity = '1'
    saveButton.disabled = false
  })

  getUserInfo()
</script>

<script defer src="https://cdn.jsdelivr.net/gh/CodeCrumbsApp/floating-form-labels@0.1.1/index.min.js"></script>
<script>
  window.CodeCrumbs.FloatLabels({
    inputSelector: ".input-settings",
    labelActiveClass: "float",
  })
</script>
