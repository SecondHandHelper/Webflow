<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.min.js"></script>
<script>
    var userItemsCount;
</script>
<script>
    let frontImageUpload = document.getElementById("frontImage");
    let frontImagePreviewUploading = document.getElementById("frontImagePreviewUploading");
    let frontImagePreview = document.getElementById("frontImagePreview");
    let brandTagImageUpload = document.getElementById("brandTagImage");
    let brandTagImagePreviewUploading = document.getElementById("brandTagImagePreviewUploading");
    let brandTagImagePreview = document.getElementById("brandTagImagePreview");
    let productImageUpload = document.getElementById("productImage");
    let productImagePreview = document.getElementById("productImagePreview");
    let defectImageUpload = document.getElementById("defectImage");
    let defectImagePreview = document.getElementById("defectImagePreview");
    let materialTagImageUpload = document.getElementById("materialTagImage");
    let materialTagImagePreview = document.getElementById("materialTagImagePreview");
    let extraImageUpload = document.getElementById("extraImage");
    let extraImagePreview = document.getElementById("extraImagePreview");

    // display image when file has been selected
    $('#frontImage').off('change');
    frontImageUpload.addEventListener('change', frontImageChangeHandler, { capture: true });
    $('#brandTagImage').off('change');
    brandTagImageUpload.addEventListener('change', brandTagImageChangeHandler, { capture: true });
    $('#productImage').off('change');
    productImageUpload.addEventListener('change', productImageChangeHandler, { capture: true });
    $('#defectImage').off('change');
    defectImageUpload.addEventListener('change', defectImageChangeHandler, { capture: true });
    $('#materialTag').off('change');
    materialTagImageUpload.addEventListener('change', materialTagImageChangeHandler, { capture: true });
    $('#extraImage').off('change');
    extraImageUpload.addEventListener('change', extraImageChangeHandler, { capture: true });

    // Hide/Show warning about difficulty to sell certain brands
    let brand = document.getElementById("itemBrand");
    let hardToSellDiv = document.getElementById("hardToSellDiv");
    let words = ["H&M", "HM", "Zara", "ASOS", "Nelly", "Gina Tricot", "BikBok", "Bik Bok", "Lindex", "Kappahl", "Cubus", "NA-KD", "NAKD", "Mango", "Ellos", "Primark", "Shein", "Vila", "Forever 21", "Pull & Bear", "Bershka", "Stradivarius", "Okänt", "Unknown", "Vet ej", "...", "Vet inte", "Okänd", "-", "Se bild"];

    brand.oninput = function () {
        shareSoldDiv.style.display = 'none';
        let value = this.value;
        if (!checkBrand(value)) {
            checkAndDisplayShareSold(value);
            //displayFindModelDiv(value);
        }
    };

    // Hide/Show extra fields for defects
    itemCondition.onchange = function () {
        let input = this.value;
        if (input == "Använd, tecken på slitage") {
            defectInfoDiv.style.display = 'block';
            itemCondition.style.color = "#333";
        } else if (input == "") {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#929292";
        } else {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#333";
        }
    };

    personalId.addEventListener("input", () => {
        const error = isValidSwedishSsn(personalId.value) ? '' : 'Ogiltigt personnummer';
        personalId.setCustomValidity(error);
    })

    async function sellItemMainAuthenticated() {
        console.log("sellItemMainAuthenticated " + new Date());

        // Be inte om telefonnummer i formuläret
        if (user.current?.phoneNumber) {
            phoneNumberDiv.style.display = "none";
            document.getElementById("itemPhoneNumber").required = false;
        }

        // Visa alla "viktiga" fält om man är inloggad
        toggleMoreInfoFields.click();

        // Create item from sessionStorage
        if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            // ... if we are redirected here from the sign-in page
            if (document.referrer.includes('/sign-in')) {
                document.getElementById('creatingItemText').style.display = 'block';
                await createItemAfterSignIn();
                const shippingMethod = sessionStorage.getItem('shippingMethod');
                if (shippingMethod) {
                    await firebase.app().functions("europe-west1").httpsCallable('updateFirebaseUser')({ preferences: { shippingMethod } });
                }
                return await nextStep({ itemCreatedFromPrefill: true });
            } else {
                // otherwise make sure to remove any previously saved item as a precaution
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
            }
        }

        // Get user's item count to be able to send 'User Activated' event
        const items = await getItems(authUser.current.uid);
        userItemsCount = items.size;
    }

    async function sellItemMain() {
      localStorage.removeItem('latestItemCreated');
        await initializeCategorySelect();
        await initializeColorConfirm();
        await initializeBrandConfirm();
        await initializeMaterialConfirm();
        await initializeSizeConfirm();
        initializeClearFormButton();
        // Be om telefonnummer i formuläret
        if (!user.current?.phoneNumber) {
            phoneNumberDiv.style.display = "block";
            document.getElementById("itemPhoneNumber").required = true;
        }
        initializeDeleteImageListeners();
        document.getElementById('clearItemForm').addEventListener('click', clearFormFields);

        if (params.id) {
          // Fill form if the user comes from a prefill link (re-sell item)
          auth.onAuthStateChanged(function (user) {
            if (!user) { document.getElementById('maiIntro').style.display = 'block'; }
          });
          document.getElementById('resellIntro').style.display = 'block';
          await fillForm(params.id);
          document.getElementById("triggerShowSellItemContent").click();
        } else if (sessionStorage.getItem('itemToBeCreatedAfterSignIn') && document.referrer.includes('/sign-in')) {
          // A new item will be created in sellItemMainAuthenticated
        } else if (localStorage.getItem('newItem') && !isDefaultFormState(JSON.parse(localStorage.getItem('newItem')))) {
          // Saved state from a previous visit to /sell-item - restore the data
          const newItem = JSON.parse(localStorage.getItem('newItem'));
          document.getElementById("frontImage").required = true;
          document.getElementById("brandTagImage").required = true;
          await fillForm(null, newItem, true);
          document.getElementById('clearItemForm').style.display = 'block';
          document.getElementById("triggerShowSellItemContent").click();
        } else {
          document.getElementById("triggerShowSellItemContent").click();
          document.getElementById("frontImage").required = true;
          document.getElementById("brandTagImage").required = true;
        }
        initializeSaveStateListeners();
        initializeRestoreOnNavigation();
    }

    // Initial state
    setupModelSearchEventListeners();
    initializeSelectColor();
    itemBrand.addEventListener('input', fieldLabelToggle('itemBrandLabel'));
    itemBrand.addEventListener('input', hideConfirmButtons);
    itemModel.addEventListener('input', fieldLabelToggle('itemModelLabel'));
    itemSize.addEventListener('input', fieldLabelToggle('itemSizeLabel'));
    itemSize.addEventListener('input', hideConfirmButtons);
    itemMaterial.addEventListener('input', fieldLabelToggle('itemMaterialLabel'));
    itemMaterial.addEventListener('input', hideConfirmButtons);
    itemOriginalPrice.addEventListener('input', fieldLabelToggle('itemOriginalPriceLabel'));
    itemAge.addEventListener('input', fieldLabelToggle('itemAgeLabel'));
    itemColor.addEventListener('input', fieldLabelToggle('itemColorLabel'));
    itemColor.addEventListener('input', hideConfirmButtons);

    addItemForm.addEventListener("submit", addItem);
    userAddressForm.addEventListener("submit", addUserDetails);
    document.getElementById('itemPhoneNumber').addEventListener("input", () => {
        const pn = formatPhoneNumber(itemPhoneNumber.value);
        const error = pn.length >= 12 && pn.includes('+') ? '' : 'Ogiltigt mobilnummer';
        itemPhoneNumber.setCustomValidity(error);
    });
    itemPersonalId.addEventListener("input", () => {
        const pid = itemPersonalId.value;
        formattedPid = formatPersonalId(pid) || '' ;
        const error = isValidSwedishSsn(formattedPid) ? '' : 'Ogiltigt personnummer';
        itemPersonalId.setCustomValidity(error);
        if (pid){
            itemPersonalId.required = true;
        } else {
            itemPersonalId.required = false; // This row doesn't seem to work, therefor the safe guard below.
            itemPersonalId.setCustomValidity('');
        }
    });
    window.addEventListener("load", (event) => {
        console.log('Page fully loaded');
    });

    /*initiate the autocomplete function on the "itemBrand" element, and pass along the brands array as possible autocomplete values:*/
    autocomplete(document.getElementById("itemBrand"), brands);

    // Call sellItemMain directly
    sellItemMain();
    // and call sellItemMainAuthenticated after/when a user has logged in
    user.whenSet(sellItemMainAuthenticated);
</script>
