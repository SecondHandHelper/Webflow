<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.min.js"></script>
<script>
    var userItemsCount;
</script>
<script>
    let frontImageUpload = document.getElementById("frontImage");
    let frontImagePreviewUploading = document.getElementById("frontImagePreviewUploading");
    let frontImagePreview = document.getElementById("frontImagePreview");
    let brandTagImageUpload = document.getElementById("brandTagImage");
    let brandTagImagePreviewUploading = document.getElementById("brandTagImagePreviewUploading");
    let brandTagImagePreview = document.getElementById("brandTagImagePreview");
    let productImageUpload = document.getElementById("productImage");
    let productImagePreview = document.getElementById("productImagePreview");
    let defectImageUpload = document.getElementById("defectImage");
    let defectImagePreview = document.getElementById("defectImagePreview");
    let materialTagImageUpload = document.getElementById("materialTagImage");
    let materialTagImagePreview = document.getElementById("materialTagImagePreview");
    let extraImageUpload = document.getElementById("extraImage");
    let extraImagePreview = document.getElementById("extraImagePreview");

    // display image when file has been selected
    frontImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            frontImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            frontImagePreview.style.backgroundImage = `url('${src}')`;
        }
    };
    brandTagImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            brandTagImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            brandTagImagePreview.style.backgroundImage = `url('${src}')`;
        }
    };
    productImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            productImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            productImagePreview.style.backgroundImage = `url('${src}')`;
        }

    };
    defectImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            defectImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            defectImagePreview.style.backgroundImage = `url('${src}')`;
        }

    };
    materialTagImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            materialTagImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            materialTagImagePreview.style.backgroundImage = `url('${src}')`;
        }

    };
    extraImageUpload.onchange = function () {
        let input = this.files[0];
        if (input) {
            let src = URL.createObjectURL(input);
            extraImagePreviewUploading.style.backgroundImage = `url('${src}')`;
            extraImagePreview.style.backgroundImage = `url('${src}')`;
        }
    };

    // Hide/Show warning about difficulty to sell certain brands
    let brand = document.getElementById("itemBrand");
    let hardToSellDiv = document.getElementById("hardToSellDiv");
    let words = ["H&M", "HM", "Zara", "ASOS", "Nelly", "Gina Tricot", "BikBok", "Bik Bok", "Lindex", "Kappahl", "Cubus", "NA-KD", "NAKD", "Mango", "Ellos", "Primark", "Shein", "Vila", "Forever 21", "Pull & Bear", "Bershka", "Stradivarius"];


    brand.onchange = function () {
        let value = this.value;
        setTimeout(function () {
            value = brand.value;
            if (!checkBrand(value)) {
                checkAndDisplayShareSold(value);
                displayFindModelDiv(value);
            }
        }, 5);
    };
    brand.oninput = function () {
        shareSoldDiv.style.display = 'none';
        let value = this.value;
        if (!checkBrand(value)) {
            checkAndDisplayShareSold(value);
            displayFindModelDiv(value);
        }
    };

    // Hide/Show extra fields for defects
    itemCondition.onchange = function () {
        let input = this.value;
        if (input == "Använd, tecken på slitage") {
            defectInfoDiv.style.display = 'block';
            itemCondition.style.color = "#333";
        } else if (input == "") {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#929292";
        } else {
            defectInfoDiv.style.display = 'none';
            itemCondition.style.color = "#333";
        }
    };

    personalId.addEventListener("input", () => {
        const error = isValidSwedishSsn(personalId.value) ? '' : 'Ogiltigt personnummer';
        personalId.setCustomValidity(error);
    })

    async function sellItemMainAuthenticated() {
        console.log("sellItemMainAuthenticated " + new Date());
        if (user.current?.phoneNumber) {
            phoneNumberDiv.style.display = "none";
            document.getElementById("itemPhoneNumber").required = false;
        }
        // Be om shippingMethod i formuläret
        if (user.current?.preferences?.shippingMethod) {
            shippingMethodDiv.style.display = "none";
        }
        // Create item from sessionStorage
        if (sessionStorage.getItem('itemToBeCreatedAfterSignIn') && document.referrer.includes('/sign-in')) {
            await createItemAfterSignIn();
            const shippingMethod = sessionStorage.getItem('shippingMethod');
            if (shippingMethod) {
                await firebase.app().functions("europe-west1").httpsCallable('updateFirebaseUser')({ preferences: { shippingMethod } });
            }
            return await nextStep({ itemCreatedFromPrefill: true });
        }

        // Get user's item count to be able to send 'User Activated' event
        const items = await getItems(authUser.current.uid);
        userItemsCount = items.size;
    }

    async function sellItemMain() {
        // Be om telefonnummer i formuläret
        if (!user.current?.phoneNumber) {
            phoneNumberDiv.style.display = "block";
            document.getElementById("itemPhoneNumber").required = true;
        }

        // Be om shippingMethod i formuläret
        if (!user.current?.preferences?.shippingMethod) {
            $('#servicePointRadioButton').val("Service point");
            $('#pickupRadioButton').val("Pickup");
            shippingMethodDiv.style.display = "block";
        }

        if (featureIsEnabled('colorCategory')) {
          document.getElementById('itemColorContainer').style.display='block';
          document.getElementById('itemCategoryContainer').style.display='block';
          await initializeCategorySelect();
        }

        // Fill form if the user comes from a prefill link
        if (params.id) {
            auth.onAuthStateChanged(function (user) {
                if (!user) {document.getElementById('maiIntro').style.display = 'block';}
            });
            document.getElementById('resellIntro').style.display = 'block';
            await fillForm(params.id);
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('addItemFormDiv').style.display = 'block';
        } else if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            document.getElementById('addItemFormDiv').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'flex';
        } else {
            document.getElementById('addItemFormDiv').style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById("frontImage").required = true;
            document.getElementById("brandTagImage").required = true;
        }
    }

    // Initial state
    setupModelSearchEventListeners();
    initializeSelectColor();
    itemBrand.addEventListener('input', fieldLabelToggle('itemBrandLabel'));
    itemModel.addEventListener('input', fieldLabelToggle('itemModelLabel'));
    itemSize.addEventListener('input', fieldLabelToggle('itemSizeLabel'));
    itemMaterial.addEventListener('input', fieldLabelToggle('itemMaterialLabel'));
    itemOriginalPrice.addEventListener('input', fieldLabelToggle('itemOriginalPriceLabel'));
    itemAge.addEventListener('input', fieldLabelToggle('itemAgeLabel'));
    itemCategory.addEventListener('change', fieldLabelToggle('itemCategoryLabel'));
    itemColor.addEventListener('input', fieldLabelToggle('itemColorLabel'))

    addItemForm.addEventListener("submit", addItem);
    userAddressForm.addEventListener("submit", addUserDetails);
    document.getElementById('itemPhoneNumber').addEventListener("input", () => {
        const pn = formatPhoneNumber(itemPhoneNumber.value);
        const error = pn.length >= 12 && pn.includes('+') ? '' : 'Ogiltigt mobilnummer';
        itemPhoneNumber.setCustomValidity(error);
    });
    /*initiate the autocomplete function on the "itemBrand" element, and pass along the brands array as possible autocomplete values:*/
    autocomplete(document.getElementById("itemBrand"), brands);

    // Call sellItemMain directly
    sellItemMain();
    // and call sellItemMainAuthenticated after/when a user has logged in
    user.whenSet(sellItemMainAuthenticated);
</script>
