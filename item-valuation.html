<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test624/itemValuation.js"></script>

<script>
    const adjustmentOk = (minPrice, maxPrice) => {
        const minInput = document.getElementById('minPrice').value;
        const maxInput = document.getElementById('maxPrice').value;
        return minInput <= minPrice * 1.5 && maxInput <= maxPrice * 1.5 && minInput < maxInput && minInput >= 100;
    }

    const hideTooltip = () => {
        for (const element of document.getElementsByClassName('tooltip-motivation')) {
            element.classList.remove('tooltip-show');
        }
    }

    const adjustmentValidations = (minPrice, maxPrice, adjustmentMinInput, adjustmentMaxInput) => {
        const adjustmentMin = Number(adjustmentMinInput.value);
        const adjustmentMax = Number(adjustmentMaxInput.value);
        adjustmentMaxInput.style.color = adjustmentMax > maxPrice * 1.5 ? '#E20000' : '#333';
        adjustmentMinInput.style.color = adjustmentMin > minPrice * 1.5 ? '#E20000' : '#333';
        if (adjustmentMax > maxPrice * 1.5 || adjustmentMin > minPrice * 1.5) {
            document.getElementById('adjustmentMotivation').style.display = 'block';
            document.getElementById('adjustmentTips').style.display = 'none';
            document.getElementById('adjustmentNote').style.display = 'none';
            document.getElementById('confirmButton').innerText = 'Skicka för granskning';
        } else if (adjustmentMax > maxPrice || adjustmentMin > minPrice) {
            document.getElementById('adjustmentNote').style.display = 'block';
            document.getElementById('adjustmentMotivation').style.display = 'none;'
            document.getElementById('adjustmentTips').style.display = 'none';
            document.getElementById('confirmButton').innerText = 'Påbörja försäljning';
        } else {
            document.getElementById('adjustmentTips').style.display = 'block';
            document.getElementById('adjustmentNote').style.display = 'none';
            document.getElementById('adjustmentMotivation').style.display = 'none';
            document.getElementById('confirmButton').innerText = 'Påbörja försäljning';
        }
    }

    const showMlValuation = async (item) => {
        const { minPriceEstimate, newMinPriceEstimate, newMaxPriceEstimate, maxPriceEstimate, decline } = item.mlValuation || {};
        const minPrice = item.infoRequests?.price?.minPrice || newMinPriceEstimate || minPriceEstimate;
        const maxPrice =  item.infoRequests?.price?.maxPrice || newMaxPriceEstimate || maxPriceEstimate;
        const estimatedPrice = Math.round((minPrice+maxPrice)/20)*10;
        document.getElementById('valuationResultDiv').style.display = 'flex';
        triggerShowContent.click();
        document.getElementById('valuationText').innerText = `${minPrice}-${maxPrice} kr`;
        if (featureIsEnabled('adjustValuation')) {
            document.getElementById('valuationExplanation').style.display = 'none';
            document.getElementById('valuationText').innerText = `${estimatedPrice} kr`;
            document.getElementById('valuationHeading').style.display = 'block';
            document.getElementById('valuationMotivation').style.display = 'flex';
            document.getElementById('valuationMotivation').dataset.text = document.getElementById('valuationExplanation').innerText;
            document.getElementById('valuationMotivation').addEventListener('click', (e) => {
                const elements = document.getElementsByClassName('tooltip-motivation');
                const visible = elements[0]?.classList.contains('tooltip-show');
                for (const element of elements) {
                    visible ? element.classList.remove('tooltip-show') : element.classList.add('tooltip-show');
                }
                e.stopPropagation();
            });
            document.body.addEventListener('click', hideTooltip);
            document.getElementById('valuationRange').style.display = 'flex';
            document.getElementById('minPrice').value = minPrice;
            document.getElementById('minPrice').disabled = true;
            document.getElementById('maxPrice').value = maxPrice;
            document.getElementById('maxPrice').disabled = true;
            document.getElementById('origMinPrice').innerText = minPrice;
            document.getElementById('origMinPrice').style.display = 'none';
            document.getElementById('origMaxPrice').innerText = maxPrice;
            document.getElementById('origMaxPrice').style.display = 'none';
            if (item.infoRequests?.price?.finalOffer === 'true') {
                document.getElementById('adjustInterval').style.display = 'none';
            }
            document.getElementById('adjustInterval').addEventListener('click', () => {
                document.getElementById('minPrice').disabled = false;
                document.getElementById('maxPrice').disabled = false;
                document.getElementById('adjustInterval').style.display = 'none';
                document.getElementById('adjustmentTips').style.display = 'block';
            })
            document.getElementById('minPrice').addEventListener('input', () => {
                const adjustmentMinInput = document.getElementById('minPrice');
                const adjustmentMin = Number(adjustmentMinInput.value);
                const adjustmentMaxInput = document.getElementById('maxPrice');
                const adjustmentMax = Number(adjustmentMaxInput.value);
                if (adjustmentMin !== minPrice) {
                    document.getElementById('origMinPrice').style.display = 'block';
                } else {
                    document.getElementById('origMinPrice').style.display = 'none';
                }
                if (adjustmentMin > adjustmentMax) {
                    document.getElementById('confirmButton').disabled = true;
                    document.getElementById('minPrice').setCustomValidity('Lägsta pris måste vara mindre än startpris');
                    document.getElementById('minPrice').reportValidity();
                } else {
                    document.getElementById('minPrice').setCustomValidity('');
                    document.getElementById('minPrice').reportValidity();
                }
                adjustmentValidations(minPrice, maxPrice, adjustmentMinInput, adjustmentMaxInput);
            });
            document.getElementById('maxPrice').addEventListener('input', () => {
                const adjustmentMaxInput = document.getElementById('maxPrice');
                const adjustmentMinInput = document.getElementById('minPrice');
                if (adjustmentMaxInput.value !== `${maxPrice}`) {
                    document.getElementById('origMaxPrice').style.display = 'block';
                } else {
                    document.getElementById('origMaxPrice').style.display = 'none';
                }
                if (adjustmentMinInput.value > adjustmentMaxInput.value) {
                    document.getElementById('confirmButton').disabled = true;
                    adjustmentMaxInput.setCustomValidity('Startpris måste vara högre än lägsta pris');
                    adjustmentMaxInput.reportValidity();
                } else {
                    adjustmentMaxInput.setCustomValidity('');
                }
                adjustmentValidations(minPrice, maxPrice, adjustmentMinInput, adjustmentMaxInput);
            });
        }
        document.getElementById('valuationText').style.display = 'block';
        if (!sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            document.getElementById('chatDiv').style.display = 'block';
        }
        if (decline) {
            await showDeclineValuation(item);
        } else {
            document.getElementById('confirmButton').addEventListener('click', () => acceptValuation(item.id, minPrice, maxPrice));
            document.getElementById('rejectButton').addEventListener('click', () => rejectValuation(item));
        }
    }

    const getItem = async (itemId) => {
        const res = await firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId })
        return { ...(res?.data || {}), id: itemId };
    }

    const main = async () => {
        window.intercomSettings = {
            app_id: "klyy0le5"
        };
        (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
        Intercom('update', { 'hide_default_launcher': true });

        const item = params.id ? (await getItem(params.id)) :
            (JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn') || '{}')?.item || JSON.parse(localStorage.getItem('latestItemCreated') || '{}'));
        if (!item) {
            console.error('Invalid item id or no saved item to show valuation for');
            return location.href = '/private';
        }
        initialPageSetup(item);
        await user.whenSet(() => showMlValuation(item));
    }

    main();
</script>
