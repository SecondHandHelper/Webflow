<script>
    let fetchedItem = null;
    const getItem = async (itemId) => {
        if (!fetchedItem) {
            const res = await firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId });
            if (res.data) {
                fetchedItem = res.data;
            }
        }
        return fetchedItem;
    }

    const getFrontImage = async () => {
        const item = JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn') || '{}')?.item;
        const itemId = params.id;
        return sessionStorage.getItem('enhancedFrontImageSmall') || item?.images?.enhancedFrontImage ||
            (await getItem(itemId)).images.enhancedFrontImageSmall || (await getItem(itemId)).images.enhancedFrontImage;
    }

    const acceptValuation = async (itemId, minPrice, maxPrice) => {
        if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            const savedItem = JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn'));
            savedItem.item.infoRequests = {
                'price.response': 'Accepted',
                'price.status': 'Resolved',
                'price.minPrice': minPrice,
                'price.maxPrice': maxPrice,
            };
            savedItem.item.minPriceEstimate = minPrice;
            savedItem.item.maxPriceEstimate = maxPrice;
            sessionStorage.setItem('itemToBeCreatedAfterSignIn', JSON.stringify(savedItem));
            return window.location.href = '/sign-in';
        } else {
            await firebase.app().functions("europe-west1").httpsCallable('saveAcceptedValuation')({
                itemId,
                minPrice,
                maxPrice
            });
            return window.location.href = '/item-confirmation';
        }
    }

    const showMlValuation = (itemValuation) => {
        const { minPrice, maxPrice, decline, humanCheckNeeded } = itemValuation;
        const itemId = JSON.parse(localStorage.getItem('latestItemCreated') || '{}')?.id;
        if (!minPrice || humanCheckNeeded) {
            if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
                return window.location.replace('/sign-in');
            } else {
                return window.location.replace('/item-confirmation');
            }
        }
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('valuationResultDiv').style.display = 'flex';
        document.getElementById('valuationText').innerText = `${minPrice}-${maxPrice} kr`;
        document.getElementById('valuationText').style.display = 'block';
        if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            // Hide chat div for non-signed in users
            document.getElementById('chatDiv').style.display = 'none';
        }
        if (decline) {
            document.getElementById('chatDivHeader').innerText = 'Ser vår värderingen konstig ut?';
            document.getElementById('deniedText').style.display = 'block';
            document.getElementById('rejectButton').style.display = 'none';
            document.getElementById('confirmButton').innerText = 'Okej'
            document.getElementById('declineExplanation').style.display = 'block';
            document.getElementById('valuationExplanation').style.display = 'none';
            document.getElementById('confirmButton').addEventListener('click', async () => {
                if (itemId) {
                    await firebase.app().functions("europe-west1").httpsCallable('markItemRejected')({ itemId, minPrice, maxPrice, userDecline: false });
                }
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
                localStorage.removeItem('newItem');
                sessionStorage.removeItem('enhancedFrontImageSmall');
                return window.location.href = '/private';
            });
        } else {
            document.getElementById('confirmButton').addEventListener('click', () => acceptValuation(itemId, minPrice, maxPrice));
            document.getElementById('rejectButton').addEventListener('click', async () => {
                if (itemId) {
                    await firebase.app().functions("europe-west1").httpsCallable('markItemRejected')({
                        itemId,
                        minPrice,
                        maxPrice,
                        userDecline: true
                    });
                }
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
                localStorage.removeItem('newItem');
                sessionStorage.removeItem('enhancedFrontImageSmall');
                return window.location.href = '/private';
            });
        }
    }

    const getMachineValuation = async (itemId) => {
        const res = await firebase.app().functions("europe-west1").httpsCallable('itemMlValuation')({ itemId });
        const { minPrice, humanCheckNeeded } = res.data;
        if (!minPrice || humanCheckNeeded) {
            await saveItemValuation(itemId, res.data);
        }
        showMlValuation(res.data);
    }

    const initialPageSetup = async () => {
        document.getElementById('itemImage').src = await getFrontImage();
        document.getElementById('chatLink').onclick = () => Intercom('showNewMessage');
        document.getElementById('valuationClose').addEventListener('click', () => {
            sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
            localStorage.removeItem('newItem');
            sessionStorage.removeItem('enhancedFrontImageSmall');
            return window.location.href = '/private';
        })
    }
    window.intercomSettings = {
        app_id: "klyy0le5"
    };
    (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
    Intercom('update', { 'hide_default_launcher': true });

    const item = JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn') || '{}')?.item ||
        JSON.parse(localStorage.getItem('latestItemCreated') || '{}');
    const itemValuation = JSON.parse(sessionStorage.getItem('itemValuation'));
    if (itemValuation && !item?.preferences?.userValuationApproval) { // TODO: Funkar inte - har vi inget item?
        acceptValuation(item.id, itemValuation.minPrice, itemValuation.maxPrice)
            .then(() => location.href = '/item-confirmatione')
            .catch(() => location.href = '/item-confirmation');
    } else {
        initialPageSetup();
        if (params.id) {
            getMachineValuation(params.id);
        }
        if (sessionStorage.getItem('itemValuation')) {
            showMlValuation(JSON.parse(sessionStorage.getItem('itemValuation')));
        }
    }
</script>
