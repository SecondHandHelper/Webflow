<script>
    const acceptValuation = async (itemId, minPrice, maxPrice) => {
        if (sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            const savedItem = JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn'));
            savedItem.item.infoRequests.price.response = 'Accepted';
            savedItem.item.infoRequests.price.status = 'Resolved';
            savedItem.item.minPriceEstimate = minPrice;
            savedItem.item.maxPriceEstimate = maxPrice;
            sessionStorage.setItem('itemToBeCreatedAfterSignIn', JSON.stringify(savedItem));
            return window.location.href = '/sign-in';
        } else {
            await firebase.app().functions("europe-west1").httpsCallable('saveAcceptedValuation')({
                itemId,
                minPrice,
                maxPrice
            });
            if (!document.referrer.includes('/private')) {
                return window.location.href = `/item-confirmation${params.id ? '?id=' + params.id : ''}`;
            } else {
                return window.location.href = `/private`;
            }
        }
    }

    const showMlValuation = async (item) => {
        const { minPriceEstimate, newMinPriceEstimate, newMaxPriceEstimate, maxPriceEstimate, decline } = item.mlValuation || {};
        const minPrice = item.infoRequests?.price?.minPrice || newMinPriceEstimate || minPriceEstimate;
        const maxPrice =  item.infoRequests?.price?.maxPrice || newMaxPriceEstimate || maxPriceEstimate;
        document.getElementById('valuationResultDiv').style.display = 'flex';
        triggerShowContent.click();
        document.getElementById('valuationText').innerText = `${minPrice}-${maxPrice} kr`;
        document.getElementById('valuationText').style.display = 'block';
        if (!sessionStorage.getItem('itemToBeCreatedAfterSignIn')) {
            document.getElementById('chatDiv').style.display = 'block';
        }
        if (decline) {
            document.getElementById('valuationText').innerText = 'Säljer ej';
            document.getElementById('valuationText').style.display = 'block';
            document.getElementById('rejectButton').style.display = 'none';
            document.getElementById('confirmButton').innerText = 'Okej'
            document.getElementById('newItemButton').style.display = 'flex';
            document.getElementById('declineExplanation').style.display = 'block';
            document.getElementById('valuationExplanation').style.display = 'none';
            document.getElementById('newItemButton').addEventListener('click', () => {
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
                localStorage.removeItem('newItem');
                sessionStorage.removeItem('enhancedFrontImageSmall');
                sessionStorage.removeItem('itemValuation');
                window.location.href = '/sell-item';
            });
            document.getElementById('confirmButton').addEventListener('click', () => {
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
                localStorage.removeItem('newItem');
                sessionStorage.removeItem('enhancedFrontImageSmall');
                sessionStorage.removeItem('itemValuation');
                window.location.href = '/private';
            });
            if (item.id) {
                await firebase.app().functions("europe-west1").httpsCallable('markItemRejected')({
                    itemId: item.id, userDecline: false
                });
            }
        } else {
            document.getElementById('confirmButton').addEventListener('click', () => acceptValuation(item.id, minPrice, maxPrice));
            document.getElementById('rejectButton').addEventListener('click', async () => {
                if (item.id) {
                    await firebase.app().functions("europe-west1").httpsCallable('markItemRejected')({
                        itemId: item.id, userDecline: true
                    });
                }
                sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
                localStorage.removeItem('newItem');
                sessionStorage.removeItem('enhancedFrontImageSmall');
                return window.location.href = '/private';
            });
        }
    }

    const initialPageSetup = (item) => {
        document.getElementById('itemImage').src = sessionStorage.getItem('enhancedFrontImageSmall') || item?.images?.enhancedFrontImageSmall || item?.images?.enhancedFrontImage;
        document.getElementById('chatLink').onclick = () => Intercom('showNewMessage',
            item.mlValuation?.decline ?
                `ID: ${item.id}\n\nGällande att ni tackade nej till ${item.brand.trim()}-${item.category.toLowerCase()}:\n\n` :
                `ID: ${item.id}\n\nGällande värderingen på ${item.mlValuation.minPriceEstimate}-${item.mlValuation.maxPriceEstimate} kr för ${item.brand.trim()}-${item.category.toLowerCase()}. Vad skulle du vilja ändra värderingen till och varför?\n\n`);
        document.getElementById('valuationClose').addEventListener('click', () => {
            sessionStorage.removeItem('itemToBeCreatedAfterSignIn');
            localStorage.removeItem('newItem');
            sessionStorage.removeItem('enhancedFrontImageSmall');
            return window.location.href = '/private';
        })
    }

    const getItem = async (itemId) => {
        const res = await firebase.app().functions("europe-west1").httpsCallable('getItem')({ itemId })
        return { ...(res?.data || {}), id: itemId };
    }

    const main = async () => {
        window.intercomSettings = {
            app_id: "klyy0le5"
        };
        (function () { var w = window; var ic = w.Intercom; if (typeof ic === "function") { ic('reattach_activator'); ic('update', w.intercomSettings); } else { var d = document; var i = function () { i.c(arguments); }; i.q = []; i.c = function (args) { i.q.push(args); }; w.Intercom = i; var l = function () { var s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'https://widget.intercom.io/widget/klyy0le5'; var x = d.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }; if (w.attachEvent) { w.attachEvent('onload', l); } else { w.addEventListener('load', l, false); } } })();
        Intercom('update', { 'hide_default_launcher': true });

        const item = params.id ? (await getItem(params.id)) :
            (JSON.parse(sessionStorage.getItem('itemToBeCreatedAfterSignIn') || '{}')?.item || JSON.parse(localStorage.getItem('latestItemCreated') || '{}'));
        if (!item) {
            console.error('Invalid item id or no saved item to show valuation for');
            return location.href = '/private';
        }
        initialPageSetup(item);
        showMlValuation(item);
    }

    main();
</script>
