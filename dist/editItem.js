!function(){async function e(e,a){sessionStorage.getItem("newItemId")||sessionStorage.setItem("newItemId",await n());let o=sessionStorage.getItem("newItemId"),i=await t(e);if(!i)throw"Fel vid bearbetning av vald bild.";let l=new FormData;l.append("itemId",o),l.append("fileName",a),l.append("file",i),l.append("temporary","true"),l.append("generateSmallImage","true");let r=await fetch("https://uploaditemimagebinary-heypmjzjfq-ew.a.run.app",{method:"POST",body:l});return await r.json()}async function t(e){return e.size<9437184?Promise.resolve(e):new Promise((t,n)=>{let a=new FileReader;a.onload=()=>{let e=document.createElement("img");e.onload=()=>{let n=e.width,a=e.height;n>a?n>1512&&(a*=1512/n,n=1512):a>2016&&(n*=2016/a,a=2016);let o=document.createElement("canvas");o.width=n,o.height=a;let i=o.getContext("2d");i.imageSmoothingQuality="high",i.drawImage(e,0,0,n,a),o.toBlob(t,"image/jpeg")},e.src=a.result,a.onerror=n},a.readAsDataURL(e)})}async function n(){try{let e=await fetch("https://generateuniqueid-heypmjzjfq-ew.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.error(`Error: ${e.statusText}`),null;let t=await e.json();return t.id}catch(e){return console.error(`Failed to fetch unique ID, generating uuidv4 id: ${e.message}`,e),uuidv4()}}async function a(e,t=!0){var n,a;let r=await o(e);return r?.url&&(t&&l("enhancedFrontImage",r.url,r.urlSmall),n="frontImage",a=window.innerWidth<=400?r.urlSmall:r.url,document.getElementById(`${n}Preview`).style.backgroundImage=`url('${a}')`,i(n)),i("frontImage"),r}async function o(e){try{let t=await firebase.app().functions("europe-west1").httpsCallable("enhanceFrontImage")({imageUrl:e});return sessionStorage.setItem("enhancedFrontImage",t.data.url),t.data}catch(e){return errorHandler.report(e),console.error(e),""}}function i(e){document.getElementById(`loading${r(e)}Icon`).style.display="none",document.getElementById(`delete${r(e)}Icon`).style.display="inline-block","frontImage"===e&&(document.getElementById("enhancedAnimationDiv").style.display="none")}function l(e,t,n){let a=JSON.parse(localStorage.getItem("newItem")||JSON.stringify({})),o=a.images||{};o[e]=t,o[`${e}Small`]=n,a.images=o,localStorage.setItem("newItem",JSON.stringify(a))}function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}async function s(t,n,a=!0){try{!function(e){let t=document.getElementById(e).parentNode.parentNode;t.querySelector(".w-file-upload-error").style.display="none"}(n);let o=URL.createObjectURL(t);document.getElementById(`${n}PreviewUploading`).style.backgroundImage=`url('${o}')`,document.getElementById(`${n}Preview`).style.backgroundImage=`url('${o}')`,function(e){if("frontImage"===e){document.getElementById(`delete${r(e)}Icon`).style.display="none",document.getElementById("enhancedAnimationDiv").style.display="block",triggerEnhancingAnimation.click();return}document.getElementById(`loading${r(e)}Icon`).style.display="inline-block",document.getElementById(`delete${r(e)}Icon`).style.display="none"}(n),m(n,"success-state");let{url:i,urlSmall:s}=await e(t,n);return a&&l(n,i,s),i}catch(e){console.error("Failed to upload image",e),errorHandler.report(e),document.getElementById(`${n}PreviewUploading`).style.backgroundImage="",document.getElementById(`${n}Preview`).style.backgroundImage="",document.getElementById(`loading${r(n)}Icon`).style.display="none",m(n,"default-state"),t.size>10485760?d(n,"Error: Bilden \xe4r f\xf6r stor. Max 10 MB."):d(n,"Error: N\xe5got gick fel vid uppladdning, f\xf6rs\xf6k igen eller kontakt oss om felet kvarst\xe5r."),document.getElementById(n).value=""}}function d(e,t){let n=document.getElementById(e).parentNode.parentNode;n.querySelector(".w-file-upload-error").style.display="block",n.querySelector(".w-file-upload-error-msg").innerText=t}function m(e,t){let n=document.getElementById(e).parentNode.parentNode.childNodes;for(let e=0;e<n.length;e++)n[e].className.includes(t)?n[e].style.display="block":n[e].style.display="none"}async function c(t,n){console.log("updateItem()"),$(".goback").data("disabled",!0);let a=new Date,o=itemSize.value,i=itemMaterial.value,l=itemBrand.value,r=itemModel.value,s=Number(itemOriginalPrice.value),d=itemAge.value,m=itemCondition.value,c=itemDefectDescription.value,g=itemUserComment.value,u={updatedAt:a,size:o,material:i,brand:l,model:r,originalPrice:s,age:d,condition:m,defectDescription:c,userComment:g};async function y(t){if(n.length>0){// START - Mark imageRequest as Resolved
await db.collection("items").doc(t).get().then(e=>{e.data()?.infoRequests?.images?.status==="Active"&&(u["infoRequests.images.status"]="Resolved")});let a=new Map;//Gather files from the form in a map "Images"
if(n.forEach(e=>{if(document.getElementById(e).files[0]){let t=document.getElementById(e).files[0];a.set(e,t)}}),// Uploads files and add the new imageUrls to the changes object
await Promise.all(Array.from(a).map(async([n,a])=>{console.log(`${n}: ${a}`),// If images was changed, set photo directions to default, since an 'info request' of images could have been shown
photoDirectionsText.style.display="block",infoRequestImagesDiv.style.display="none";let{url:o}=await e(a,n);await firebase.app().functions("europe-west1").httpsCallable("saveItemImage")({itemId:t,fileName:n,url:o})})),n.indexOf("frontImage")>-1){// Front image was changed, also save the enhancedFrontImage in the right place
let e=await firebase.app().functions("europe-west1").httpsCallable("getItem")({itemId:t}),n=e.data;await firebase.app().functions("europe-west1").httpsCallable("saveItemImage")({itemId:t,fileName:"enhancedFrontImage",url:`${sessionStorage.getItem("enhancedFrontImage")}`}),u["images.versionsStatus.enhancedFrontImage"]="",n.images.coverImage===n.images.enhancedFrontImage&&(u["images.coverImage"]="",u["images.coverImageSmall"]="",u["images.coverImageMedium"]="",u["images.coverImageLarge"]="",u["images.versionsStatus.coverImage"]="")}}await I(t,u),sessionStorage.removeItem("enhancedFrontImage")}async function I(e,t){console.log("updateItemDoc()"),// Update item in FS without the images first, only because that's how I did it when adding an item.
console.log("CHANGES: ",t);let n=db.collection("items").doc(e);await n.update(t).then(t=>{console.log("Document updated with ID: ",e),saveChangesButtonText.style.color="#7a7575",saveChangesButtonText.innerHTML="Sparat"}).catch(e=>{errorHandler.report(e),console.error("Error adding document: ",e)})}await y(t),$(".goback").data("disabled",!1)}async function g(e){try{let n=authUser.current.uid,a=await firebase.app().functions("europe-west1").httpsCallable("getItem")({itemId:e}),o=a.data;if(n===o.user||"3OkW5av20HP8ScpUDS8ip9fBEZr1"===n){console.log("Item data:",o),o.sex;let e=o.size,n=o.material,a=o.brand,i=o.model,l=o.originalPrice;l<=0&&(l=null);let r=o.age,s=o.condition;o.defects;let d=o.defectDescription;o.noSmoke,o.noAnimals;let m=o.userComment,c=o.infoRequests,g=o.images;o.status;let u="";// Populate images
function t(e,t){document.getElementById(`${e}Preview`).style.backgroundImage=`url('${t}')`;let n=document.getElementById(e).parentNode.parentNode.childNodes;for(let e=0;e<n.length;e++)n[e].className.includes("success-state")?n[e].style.display="block":n[e].style.display="none"}for(let e in o.category&&(u=o.category),g){let n=["brandTagImage","materialTagImage","defectImage","productImage","extraImage"],a=g[`${e}Small`]||g[`${e}Medium`]||g[`${e}Large`]||g[e];n.includes(e)&&t(e,a)}// Special case for frontImage where we want to show the enhancedFrontImage
let y=g.enhancedFrontImageSmall||g.enhancedFrontImageMedium||g.enhancedFrontImageLarge||g.enhancedFrontImage||g.frontImageSmall||g.frontImageMedium||g.frontImageLarge||g.frontImage;y&&t("frontImage",y),// Populate text input fields
pageTitle.innerHTML=a,pageSubTitle.innerHTML=u,itemSize.setAttribute("value",e),itemBrand.setAttribute("value",a),itemMaterial.setAttribute("value",n),itemModel.setAttribute("value",i),itemOriginalPrice.setAttribute("value",l),itemUserComment.value=m,itemDefectDescription.value=d;// Populate select fields
let I=itemAge.options;for(let e=0;e<I.length;e++)r===I[e].attributes.value.value&&(itemAge.selectedIndex=e,""!==r&&(itemAge.style.color="#333"));I=itemCondition.options;for(let e=0;e<I.length;e++)s===I[e].innerText&&(itemCondition.selectedIndex=e,itemCondition.style.color="#333","Anv\xe4nd, tecken p\xe5 slitage"===I[e].innerText&&(defectInfoDiv.style.display="block"));c?.images?.status==="Active"&&c?.images?.description&&(photoDirectionsText.style.display="none",infoRequestImagesText.innerHTML=c.images.description,infoRequestImagesDiv.style.display="flex"),// Show form
updateItemFormDiv.style.display="block",pageTitleDiv.style.display="flex",loadingDiv.style.display="none"}}catch(e){errorHandler.report(e),console.log("Error getting item document:",e)}}async function u(){saveChangesButtonText.style.color="#e2dede",console.log("changedImages: ",y),await c(params.id,y)}let y=[];sessionStorage.removeItem("enhancedFrontImage"),["frontImage","brandTagImage","materialTagImage","productImage","defectImage","extraImage"].forEach(function(e){let t=document.getElementById(e),n=document.getElementById(`${e}PreviewUploading`),a=document.getElementById(`${e}Preview`);t.addEventListener("change",function(){let e=this.files[0];if(e){let t=URL.createObjectURL(e);n.style.backgroundImage=`url('${t}')`,a.style.backgroundImage=`url('${t}')`}})}),document.getElementById("frontImage").addEventListener("change",async function(){let e=this.files[0];if(e){let t=await s(e,"frontImage",!1);if(!t||0===Object.keys(t).length)return;await a(t,!1)}}),document.querySelectorAll("input").forEach(function(e){e.addEventListener("input",function(){saveChangesButtonText.style.color="#c24700",saveChangesButtonText.innerHTML="Spara",e.id.includes("Image")&&y.push(e.id)})}),itemCondition.onchange=function(){let e=this.value;"Anv\xe4nd, tecken p\xe5 slitage"==e?(defectInfoDiv.style.display="block",itemCondition.style.color="#333"):""==e?(defectInfoDiv.style.display="none",itemCondition.style.color="#929292"):(defectInfoDiv.style.display="none",itemCondition.style.color="#333")},itemAge.onchange=function(){""!=this.value?itemAge.style.color="#333":itemAge.style.color="#929292"},saveChangesButton.addEventListener("click",u),user.whenSet(async()=>await g(params.id)),autocomplete(document.getElementById("itemBrand"),brands)}();//# sourceMappingURL=editItem.js.map

//# sourceMappingURL=editItem.js.map
