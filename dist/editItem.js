!function(){function e(e,t,n,a){Object.defineProperty(e,t,{get:n,set:a,enumerable:!0,configurable:!0})}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},a={},o=t.parcelRequire81ca;null==o&&((o=function(e){if(e in n)return n[e].exports;if(e in a){var t=a[e];delete a[e];var o={id:e,exports:{}};return n[e]=o,t.call(o.exports,o,o.exports),o.exports}var i=Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}).register=function(e,t){a[e]=t},t.parcelRequire81ca=o),(0,o.register)("aqjML",function(t,n){async function a(e,t){sessionStorage.getItem("newItemId")||sessionStorage.setItem("newItemId",await i());let n=sessionStorage.getItem("newItemId"),a=await o(e);if(!a)throw"Fel vid bearbetning av vald bild.";let r=new FormData;r.append("itemId",n),r.append("fileName",t),r.append("file",a),r.append("temporary","true"),r.append("generateSmallImage","true");let l=await fetch("https://uploaditemimagebinary-heypmjzjfq-ew.a.run.app",{method:"POST",body:r});return await l.json()}async function o(e){return e.size<9437184?Promise.resolve(e):new Promise((t,n)=>{let a=new FileReader;a.onload=()=>{let e=document.createElement("img");e.onload=()=>{let n=e.width,a=e.height;n>a?n>1512&&(a=1512/n*a,n=1512):a>2016&&(n=2016/a*n,a=2016);let o=document.createElement("canvas");o.width=n,o.height=a;let i=o.getContext("2d");i.imageSmoothingQuality="high",i.drawImage(e,0,0,n,a),o.toBlob(t,"image/jpeg")},e.src=a.result,a.onerror=n},a.readAsDataURL(e)})}async function i(){try{let e=await fetch("https://generateuniqueid-heypmjzjfq-ew.a.run.app",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.error(`Error: ${e.statusText}`),null;return(await e.json()).id}catch(e){return console.error(`Failed to fetch unique ID, generating uuidv4 id: ${e.message}`,e),uuidv4()}}async function r(e,t=!0){let n=await l(e);return n?.url&&(t&&d("enhancedFrontImage",n.url,n.urlSmall),c("frontImage",window.innerWidth<=400?n.urlSmall:n.url)),s("frontImage"),n}async function l(e){try{let t=await firebase.app().functions("europe-west1").httpsCallable("enhanceFrontImage")({imageUrl:e});return sessionStorage.setItem("enhancedFrontImage",t.data.url),t.data}catch(e){return errorHandler.report(e),console.error(e),""}}function s(e){document.getElementById(`loading${m(e)}Icon`).style.display="none",document.getElementById(`delete${m(e)}Icon`).style.display="inline-block","frontImage"===e&&(document.getElementById("enhancedAnimationDiv").style.display="none")}function d(e,t,n){let a=JSON.parse(localStorage.getItem("newItem")||JSON.stringify({})),o=a.images||{};o[e]=t,o[`${e}Small`]=n,a.images=o,localStorage.setItem("newItem",JSON.stringify(a))}function c(e,t){document.getElementById(`${e}Preview`).style.backgroundImage=`url('${t}')`,s(e)}function m(e){return e.charAt(0).toUpperCase()+e.slice(1)}async function u(e,t,n=!0){try{document.getElementById(t).parentNode.parentNode.querySelector(".w-file-upload-error").style.display="none";let o=URL.createObjectURL(e);document.getElementById(`${t}PreviewUploading`).style.backgroundImage=`url('${o}')`,document.getElementById(`${t}Preview`).style.backgroundImage=`url('${o}')`,f(t),p(t,"success-state");let{url:i,urlSmall:r}=await a(e,t);return n&&d(t,i,r),i}catch(n){console.error("Failed to upload image",n),errorHandler.report(n),document.getElementById(`${t}PreviewUploading`).style.backgroundImage="",document.getElementById(`${t}Preview`).style.backgroundImage="",document.getElementById(`loading${m(t)}Icon`).style.display="none",p(t,"default-state"),e.size>10485760?g(t,"Error: Bilden är för stor. Max 10 MB."):g(t,"Error: Något gick fel vid uppladdning, försök igen eller kontakt oss om felet kvarstår."),document.getElementById(t).value=""}}function g(e,t){let n=document.getElementById(e).parentNode.parentNode;n.querySelector(".w-file-upload-error").style.display="block",n.querySelector(".w-file-upload-error-msg").innerText=t}function p(e,t){let n=document.getElementById(e).parentNode.parentNode.childNodes;for(let e=0;e<n.length;e++)n[e].className.includes(t)?n[e].style.display="block":n[e].style.display="none"}function f(e){if("frontImage"===e){document.getElementById(`delete${m(e)}Icon`).style.display="none",document.getElementById("enhancedAnimationDiv").style.display="block",triggerEnhancingAnimation.click();return}document.getElementById(`loading${m(e)}Icon`).style.display="inline-block",document.getElementById(`delete${m(e)}Icon`).style.display="none"}e(t.exports,"uploadTempImage",function(){return a}),e(t.exports,"requestUniqueId",function(){return i}),e(t.exports,"enhanceFrontImage",function(){return r}),e(t.exports,"rememberNewItemImageField",function(){return d}),e(t.exports,"showImagePreview",function(){return c}),e(t.exports,"showDeleteImageIcon",function(){return s}),e(t.exports,"capitalizeFirstLetter",function(){return m}),e(t.exports,"uploadImageAndShowPreview",function(){return u}),e(t.exports,"showLoadingIcon",function(){return f}),e(t.exports,"showImageState",function(){return p})});var i=o("aqjML");async function r(e,t){console.log("updateItem()"),$(".goback").data("disabled",!0);let n=new Date,a=itemSize.value,o=itemMaterial.value,r=itemBrand.value,l=itemModel.value,s=Number(itemOriginalPrice.value),d=itemAge.value,c={updatedAt:n,size:a,material:o,brand:r,model:l,originalPrice:s,age:d,condition:itemCondition.value,defectDescription:itemDefectDescription.value,userComment:itemUserComment.value};async function m(e){if(t.length>0){await db.collection("items").doc(e).get().then(e=>{e.data()?.infoRequests?.images?.status==="Active"&&(c["infoRequests.images.status"]="Resolved")});let n=new Map;if(t.forEach(e=>{if(document.getElementById(e).files[0]){let t=document.getElementById(e).files[0];n.set(e,t)}}),await Promise.all(Array.from(n).map(async([t,n])=>{console.log(`${t}: ${n}`),photoDirectionsText.style.display="block",infoRequestImagesDiv.style.display="none";let{url:a}=await (0,i.uploadTempImage)(n,t);await firebase.app().functions("europe-west1").httpsCallable("saveItemImage")({itemId:e,fileName:t,url:a})})),t.indexOf("frontImage")>-1){let t=(await firebase.app().functions("europe-west1").httpsCallable("getItem")({itemId:e})).data;await firebase.app().functions("europe-west1").httpsCallable("saveItemImage")({itemId:e,fileName:"enhancedFrontImage",url:`${sessionStorage.getItem("enhancedFrontImage")}`}),c["images.versionsStatus.enhancedFrontImage"]="",t.images.coverImage===t.images.enhancedFrontImage&&(c["images.coverImage"]="",c["images.coverImageSmall"]="",c["images.coverImageMedium"]="",c["images.coverImageLarge"]="",c["images.versionsStatus.coverImage"]="")}}await u(e,c),sessionStorage.removeItem("enhancedFrontImage")}async function u(e,t){console.log("updateItemDoc()"),console.log("CHANGES: ",t);let n=db.collection("items").doc(e);await n.update(t).then(t=>{console.log("Document updated with ID: ",e),saveChangesButtonText.style.color="#7a7575",saveChangesButtonText.innerHTML="Sparat"}).catch(e=>{errorHandler.report(e),console.error("Error adding document: ",e)})}await m(e),$(".goback").data("disabled",!1)}async function l(e){try{let n=authUser.current.uid,a=(await firebase.app().functions("europe-west1").httpsCallable("getItem")({itemId:e})).data;if(n===a.user||"3OkW5av20HP8ScpUDS8ip9fBEZr1"===n){console.log("Item data:",a),a.sex;let e=a.size,n=a.material,o=a.brand,i=a.model,r=a.originalPrice;r<=0&&(r=null);let l=a.age,s=a.condition;a.defects;let d=a.defectDescription;a.noSmoke,a.noAnimals;let c=a.userComment,m=a.infoRequests,u=a.images;a.status;let g="";function t(e,t){document.getElementById(`${e}Preview`).style.backgroundImage=`url('${t}')`;let n=document.getElementById(e).parentNode.parentNode.childNodes;for(let e=0;e<n.length;e++)n[e].className.includes("success-state")?n[e].style.display="block":n[e].style.display="none"}for(let e in a.category&&(g=a.category),u){let n=["brandTagImage","materialTagImage","defectImage","productImage","extraImage"],a=u[`${e}Small`]||u[`${e}Medium`]||u[`${e}Large`]||u[e];n.includes(e)&&t(e,a)}let p=u.enhancedFrontImageSmall||u.enhancedFrontImageMedium||u.enhancedFrontImageLarge||u.enhancedFrontImage||u.frontImageSmall||u.frontImageMedium||u.frontImageLarge||u.frontImage;p&&t("frontImage",p),pageTitle.innerHTML=o,pageSubTitle.innerHTML=g,itemSize.setAttribute("value",e),itemBrand.setAttribute("value",o),itemMaterial.setAttribute("value",n),itemModel.setAttribute("value",i),itemOriginalPrice.setAttribute("value",r),itemUserComment.value=c,itemDefectDescription.value=d;let f=itemAge.options;for(let e=0;e<f.length;e++)l===f[e].attributes.value.value&&(itemAge.selectedIndex=e,""!==l&&(itemAge.style.color="#333"));f=itemCondition.options;for(let e=0;e<f.length;e++)s===f[e].innerText&&(itemCondition.selectedIndex=e,itemCondition.style.color="#333","Använd, tecken på slitage"===f[e].innerText&&(defectInfoDiv.style.display="block"));m?.images?.status==="Active"&&m?.images?.description&&(photoDirectionsText.style.display="none",infoRequestImagesText.innerHTML=m.images.description,infoRequestImagesDiv.style.display="flex"),updateItemFormDiv.style.display="block",pageTitleDiv.style.display="flex",loadingDiv.style.display="none"}}catch(e){errorHandler.report(e),console.log("Error getting item document:",e)}}async function s(){saveChangesButtonText.style.color="#e2dede",console.log("changedImages: ",d),await r(params.id,d)}let d=[];sessionStorage.removeItem("enhancedFrontImage"),["frontImage","brandTagImage","materialTagImage","productImage","defectImage","extraImage"].forEach(function(e){let t=document.getElementById(e),n=document.getElementById(`${e}PreviewUploading`),a=document.getElementById(`${e}Preview`);t.addEventListener("change",function(){let e=this.files[0];if(e){let t=URL.createObjectURL(e);n.style.backgroundImage=`url('${t}')`,a.style.backgroundImage=`url('${t}')`}})}),document.getElementById("frontImage").addEventListener("change",async function(){let e=this.files[0];if(e){let t=await (0,i.uploadImageAndShowPreview)(e,"frontImage",!1);if(!t||0===Object.keys(t).length)return;await (0,i.enhanceFrontImage)(t,!1)}}),document.querySelectorAll("input").forEach(function(e){e.addEventListener("input",function(){saveChangesButtonText.style.color="#c24700",saveChangesButtonText.innerHTML="Spara",e.id.includes("Image")&&d.push(e.id)})}),itemCondition.onchange=function(){let e=this.value;"Använd, tecken på slitage"==e?(defectInfoDiv.style.display="block",itemCondition.style.color="#333"):""==e?(defectInfoDiv.style.display="none",itemCondition.style.color="#929292"):(defectInfoDiv.style.display="none",itemCondition.style.color="#333")},itemAge.onchange=function(){""!=this.value?itemAge.style.color="#333":itemAge.style.color="#929292"},saveChangesButton.addEventListener("click",s),user.whenSet(async()=>await l(params.id)),autocomplete(document.getElementById("itemBrand"),brands)}();
//# sourceMappingURL=editItem.js.map
