<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>

<script>
  // Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyCMWv3TzZuGPDg41K8wa_PY10rgtitoCnA",
    authDomain: "second-hand-helper.firebaseapp.com",
    projectId: "second-hand-helper",
    storageBucket: "second-hand-helper.appspot.com",
    messagingSenderId: "886292162262",
    appId: "1:886292162262:web:a5679ec376bdec00600b77",
    measurementId: "G-654T8V21EB"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  var functions = firebase.functions();
  var storage = firebase.storage();
  var auth = firebase.auth();

  const user = {
    value: null,
    callbacks: [],
    get current() {
      return this.value;
    },
    set current(newVal) {
      this.value = newVal;
      this.callbacks.forEach((cb) => {
        typeof cb === 'function' && cb(newVal)
      });
    },
    whenSet(cb) {
      this.callbacks.push(cb);
      if (this.value) {
        cb(this.value);
      }
    },
  };
  const authUser = {
    value: null,
    callbacks: [],
    get current() {
      return this.value;
    },
    set current(newVal) {
      this.value = newVal;
      this.callbacks.forEach((cb) => cb(newVal));
    },
  };
</script>


<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/general.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.25/infoRequestsFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/referralFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/cookieManagement.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.25/autocomplete-brands.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.25/loadItemCards.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test258/sellItem.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.25/sellItemModelSearch.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/editItem.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/private.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.25/settings.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test254/signIn.js"></script>

<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWV4J65" height="0" width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->

<script>

  // Set attribution cookies (could be put on any campaign page)
  checkCookie("utm_campaign");
  checkCookie("utm_source");
  checkCookie("utm_medium");
  checkCookie("utm_term");
  checkCookie("utm_content");

  // GET ITEMS
  // This function returns all the users items from DB in the form of a firestore "querySnapshot"
  async function getItems(userId) {
    return db.collection("items")
      .where("user", "==", userId)
      .where("createdAt", "!=", false)
      .orderBy('createdAt', 'desc')
      .get();
  }

</script>
<script>
  // GO BACK LINKS
  $(document).ready(function () {
    $(".goback").click(function () {
      if (document.referrer.includes(window.location.origin)) {
        window.history.back();
      } else {
        if (user) {
          window.location.href = window.location.origin + "/private";
        } else {
          window.location.href = window.location.origin;
        }
      }
    });
  });

  function linkClickTracker(event) {
    if (event.currentTarget.id) {
      console.log('Clicked link ', event.currentTarget.id);
      analytics.track('Click', { elementID: event.currentTarget.id });
    }
  }

  // TRACK LINK CLICKS
  document.querySelectorAll("a").forEach(link => link.addEventListener('click', linkClickTracker) );

  // SEGMENT IDENTIFY
  function identify() {
    const now = new Date().toISOString();
    let createdAt = new Date(authUser.current.metadata.creationTime).toISOString();
    let latestLogin = new Date(authUser.current.metadata.lastSignInTime).toISOString();
    let signInMethod = authUser.current.providerData[0].providerId;
    const firstName = user.current.addressFirstName ? user.current.addressFirstName : null;
    const lastName = user.current.addressLastName ? user.current.addressLastName : null;
    const email = user.current.email ? user.current.email : null;
    const phone = user.current.phoneNumber ? user.current.phoneNumber : null;
    const street = user.current.addressStreetAddress ? user.current.addressStreetAddress : null;
    const city = user.current.addressCity ? user.current.addressCity : null;
    const postalCode = user.current.addressPostalCode ? user.current.addressPostalCode : null;
    const doorCode = user.current.addressDoorCode ? user.current.addressDoorCode : null;
    let campaign = {};
    if (user.current.attribution) {
      campaign["name"] = user.current.attribution.utm_campaign ? user.current.attribution.utm_campaign : null;
      campaign["source"] = user.current.attribution.utm_source ? user.current.attribution.utm_source : null;
      campaign["medium"] = user.current.attribution.utm_medium ? user.current.attribution.utm_medium : null;
      campaign["term"] = user.current.attribution.utm_term ? user.current.attribution.utm_term : null;
      campaign["content"] = user.current.attribution.utm_content ? user.current.attribution.utm_content : null;
    }
    campaign = Object.keys(campaign).length > 0 ? campaign : null;

    analytics.identify(`${authUser.current.uid}`, {
      createdAt,
      firstName,
      lastName,
      email,
      phone,
      address: {
        street,
        city,
        postalCode,
        doorCode
      },
      latestLogin,
      latestPageView: now,
      signInMethod,
      campaign
    });
  }

  // FUNCTIONS PRIVATE PAGE
  function formatPhoneNumber(str) {
    str = str.replace(/[^0-9+]/g, '');
    if (str.slice(0, 1) == 0 && str.length == 10) { //0769419519
      str = str.substring(1);
      str = "+46" + str;
    }
    if (str.slice(0, 1) == 7 && str.length == 9) { //769419519
      str = "+46" + str;
    }
    if (str.slice(0, 2) == '00' && str.length == 13) { //0046769419519
      str = str.substring(2);
      str = "+" + str;
    }
    return str;
  }

  // FEATURE TOGGLE FUNCTION
  var featureConfig = {
    alpha: { C2C: true, modelDB: true },
    beta: { C2C: true, modelDB: true },
    default: { C2C: true, modelDB: true }
  };

  function featureIsEnabled(featureName) {
    if (user.current?.testGroups) {
      if (user.current.testGroups.includes('alpha')) {
        return featureConfig.alpha[featureName]
      }
      if (user.current.testGroups.includes('beta')) {
        return featureConfig.beta[featureName]
      }
    } else {
      return featureConfig.default[featureName]
    }
  }

  // SEND SLACK PING
  async function slackPing(channel, text) {
    fetch('https://europe-west3-second-hand-helper.cloudfunctions.net/slackPing', {
      method: 'POST',
      body: JSON.stringify({
        text,
        channel
      }),
      headers: {
        'Content-Type': 'application/json'
      }
    });
  }
</script>
