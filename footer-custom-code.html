<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.14/general.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.10/infoRequestsFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.10/referralFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.10/cookieManagement.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.15/autocomplete-brands.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.11/loadItemCards.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test194/sellItem.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/test194/sellItemModelSearch.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.1.11/private.js"></script>

<script>
  // Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyCMWv3TzZuGPDg41K8wa_PY10rgtitoCnA",
    authDomain: "second-hand-helper.firebaseapp.com",
    projectId: "second-hand-helper",
    storageBucket: "second-hand-helper.appspot.com",
    messagingSenderId: "886292162262",
    appId: "1:886292162262:web:a5679ec376bdec00600b77",
    measurementId: "G-654T8V21EB"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  var functions = firebase.functions();
  var storage = firebase.storage();
  var auth = firebase.auth();
</script>

<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWV4J65" height="0" width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->

<script>
  // GET USER
  var user;
  var authUser;
  firebase.auth().onAuthStateChanged((result) => {
    const now = new Date().toISOString();

    if (result) {
      // Get and set current user
      authUser = result;
      db.collection("users").doc(authUser.uid).get().then((doc) => {
        if (doc.exists) {
          user = doc.data();
          console.log("user:", user);
          console.log("authUser", authUser);
          console.log("featureIsEnabled('C2C')", featureIsEnabled('C2C'));
          console.log("featureIsEnabled('modelDB')", featureIsEnabled('modelDB'));
          identify();

          setPreferredLogInMethodCookie(authUser.providerData[0].providerId);
          // Go to logged in pages when user authenticated
          const path = window.location.pathname;
          var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          if (isMobile && (path === "/" || path === "/sign-in")) { window.location.replace('./private'); }
        }

        // Run Main function if exists
        if (typeof window.main === "function") { main(); }
      }).catch((error) => { console.log("Error getting document:", error); });
    } else {
      console.log('No user');
      // Go to landing page if no user and on logged in pages
      const path = window.location.pathname;
      if (path === "/private" || path === "/personal-id-form" || path === "/address-form" || path === "/item" || path === "/sell-item" || path === "/ship-item" || path === "/edit-item" || path === "/order-bags") {
        window.location.replace('./');
      }

      // Latest page view for logged out users
      analytics.identify({ latestPageView: now });

      // Run main function
      if (typeof window.main === "function") {
        main();
      }
    }
  });

  // Set attribution cookies (could be put on any campaign page)
  checkCookie("utm_campaign");
  checkCookie("utm_source");
  checkCookie("utm_medium");
  checkCookie("utm_term");
  checkCookie("utm_content");

  // GET ITEMS
  // This function returns all the users items from DB in the form of a firestore "querySnapshot"
  async function getItems(userId) {
    return db.collection("items")
      .where("user", "==", userId)
      .where("createdAt", "!=", false)
      .orderBy('createdAt', 'desc')
      .get();
  }

</script>
<script>
  // GO BACK LINKS
  $(document).ready(function () {
    $(".goback").click(function () {
      if (document.referrer.includes(window.location.origin)) {
        window.history.back();
      } else {
        if (user) {
          window.location.href = window.location.origin + "/private";
        } else {
          window.location.href = window.location.origin;
        }
      }
    });
  });

  // TRACK LINK CLICKS
  const linkElements = document.querySelectorAll("a");
  linkElements.forEach(link => {
    link.addEventListener('click', function handleClick(event) {
      if (link.id) {
        console.log('Clicked link ', link.id);
        analytics.track('Click', { elementID: link.id });
      }
    });
  });

  // SEGMENT IDENTIFY
  function identify() {
    const now = new Date().toISOString();
    let createdAt = new Date(authUser.metadata.creationTime).toISOString();
    let latestLogin = new Date(authUser.metadata.lastSignInTime).toISOString();
    let signInMethod = authUser.providerData[0].providerId;
    const firstName = user.addressFirstName ? user.addressFirstName : null;
    const lastName = user.addressLastName ? user.addressLastName : null;
    const email = user.email ? user.email : null;
    const phone = user.phoneNumber ? user.phoneNumber : null;
    const street = user.addressStreetAddress ? user.addressStreetAddress : null;
    const city = user.addressCity ? user.addressCity : null;
    const postalCode = user.addressPostalCode ? user.addressPostalCode : null;
    const doorCode = user.addressDoorCode ? user.addressDoorCode : null;
    const replace = user.replace ? user.replace : null;
    let campaign = {};
    if (user.attribution) {
      campaign["name"] = user.attribution.utm_campaign ? user.attribution.utm_campaign : null;
      campaign["source"] = user.attribution.utm_source ? user.attribution.utm_source : null;
      campaign["medium"] = user.attribution.utm_medium ? user.attribution.utm_medium : null;
      campaign["term"] = user.attribution.utm_term ? user.attribution.utm_term : null;
      campaign["content"] = user.attribution.utm_content ? user.attribution.utm_content : null;
    }
    campaign = Object.keys(campaign).length > 0 ? campaign : null;

    analytics.identify(`${authUser.uid}`, {
      createdAt,
      firstName,
      lastName,
      email,
      phone,
      address: {
        street,
        city,
        postalCode,
        doorCode
      },
      latestLogin,
      latestPageView: now,
      signInMethod,
      campaign
    });
  }

  // FUNCTIONS PRIVATE PAGE
  function formatPhoneNumber(str) {
    if (str.slice(0, 1) == 0 && str.length == 10) {
      str = str.substring(1);
      str = "+46" + str;
    }
    if (str.slice(0, 1) == 7 && str.length == 9) {
      str = "+46" + str;
    }
    return str;
  }

  // FEATURE TOGGLE FUNCTION
  var featureConfig = {
    alpha: { C2C: true, modelDB: true },
    beta: { C2C: true, modelDB: true },
    default: { C2C: true, modelDB: false }
  };

  function featureIsEnabled(featureName) {
    if (user?.testGroups) {
      if (user.testGroups.includes('alpha')) {
        return featureConfig.alpha[featureName]
      }
      if (user.testGroups.includes('beta')) {
        return featureConfig.beta[featureName]
      }
    } else {
      return featureConfig.default[featureName]
    }
  }

  // SEND SLACK PING
  async function slackPing(channel, text) {
    fetch('https://europe-west3-second-hand-helper.cloudfunctions.net/slackPing', {
      method: 'POST',
      body: JSON.stringify({
        text,
        channel
      }),
      headers: {
        'Content-Type': 'application/json'
      }
    });
  }
</script>
