<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.37/general.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.30/infoRequestsFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.32/referralFunctions.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.34/cookieManagement.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.1/autocomplete-brands.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.37/onPageLoad.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.37/loadCardLists.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>
<script src="https://rawcdn.githack.com/SecondHandHelper/Webflow/v1.0.37/sellItem.js"></script>

<script>
  // Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyCMWv3TzZuGPDg41K8wa_PY10rgtitoCnA",
    authDomain: "second-hand-helper.firebaseapp.com",
    projectId: "second-hand-helper",
    storageBucket: "second-hand-helper.appspot.com",
    messagingSenderId: "886292162262",
    appId: "1:886292162262:web:a5679ec376bdec00600b77",
    measurementId: "G-654T8V21EB"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  var functions = firebase.functions();
  var storage = firebase.storage();
  var auth = firebase.auth();
</script>

<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWV4J65" height="0" width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->

<script>
  // GET USER
  var user;
  var authUser;
  firebase.auth().onAuthStateChanged((result) => {
    const now = new Date().toISOString();

    if (result) {
      authUser = result;

      // Get and set currentUser
      db.collection("users").doc(authUser.uid).get().then((doc) => {
        if (doc.exists) {
          user = doc.data();
          console.log("user:", user);
          console.log("authUser", authUser);

          // FB Pixel
          fbq('init', '681886049842735', { 'external_id': authUser.uid });
          fbq('track', 'PageView');

          // Own Attribution (Will be removed)
          tryAttribution();

          let createdAt = new Date(authUser.metadata.creationTime).toISOString();
          let latestLogin = new Date(authUser.metadata.lastSignInTime).toISOString();

          // Segment
          const firstName = user.addressFirstName ? user.addressFirstName : null;
          const lastName = user.addressLastName ? user.addressLastName : null;
          const email = user.email ? user.email : null;
          const phone = user.phoneNumber ? user.phoneNumber : null;
          const street = user.addressStreetAddress ? user.addressStreetAddress : null;
          const city = user.addressCity ? user.addressCity : null;
          const postalCode = user.addressPostalCode ? user.addressPostalCode : null;
          const doorCode = user.addressDoorCode ? user.addressDoorCode : null;
          const replace = user.replace ? user.replace : null;

          analytics.identify(`${authUser.uid}`, {
            createdAt,
            firstName,
            lastName,
            email,
            phone,
            address: {
              street,
              city,
              postalCode,
              doorCode
            },
            latestLogin,
            latestPageView: now
          });
        }

        if (typeof window.main === "function") {
          main();
        }
      }).catch((error) => { console.log("Error getting document:", error); });
    } else {
      // Go to landing page if no user and on logged in pages
      const path = window.location.pathname
      if (path === "/private" || path === "/personal-id-form" || path === "/address-form" || path === "/item" || path === "/sell-item") {
        window.location.href = window.location.origin;
      }
      analytics.identify({
        latestPageView: now
      });
      console.log('No user');
    }
  });
</script>
<script>
  // FUNCTIONS PRIVATE PAGE
  function formatPhoneNumber(str) {
    if (str.slice(0, 1) == 0 && str.length == 10) {
      str = str.substring(1);
      str = "+46" + str;
    }
    if (str.slice(0, 1) == 7 && str.length == 9) {
      str = "+46" + str;
    }
    return str;
  }
</script>