<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/gh/trosman/second-hand-helper@v0.0.4/general.js"></script>

<script>
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  var firebaseConfig = {
    apiKey: "AIzaSyCMWv3TzZuGPDg41K8wa_PY10rgtitoCnA",
    authDomain: "second-hand-helper.firebaseapp.com",
    projectId: "second-hand-helper",
    storageBucket: "second-hand-helper.appspot.com",
    messagingSenderId: "886292162262",
    appId: "1:886292162262:web:a5679ec376bdec00600b77",
    measurementId: "G-654T8V21EB"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  var functions = firebase.functions();
  var storage = firebase.storage();
</script>

<script>
  // FUNCTIONS FOR START PAGE
  function loadRecentlySold() {
    console.log("Funktionen loadRecentlySold påbörjad!");
    var data = {};

    // [START fb_functions_call_add_message_error]
    var addMessage = firebase.functions().httpsCallable('addMessage');

    addMessage()
      .then((result) => {
        // Read result of the Cloud Function.
        console.log('Cloud Function är klar! Nu gör vi något med resultatet!');

        var itemListRecentlySoldStartPage = document.getElementById('itemListRecentlySoldStartPage');
        itemListRecentlySoldStartPage.innerHTML = "";

        data = result.data;

        for (var key in data) {
          if (data.hasOwnProperty(key)) {
            var brand = data[key].brand;
            var soldPrice = data[key].soldPrice;
            var imageUrl = data[key].imageUrl;
            if (soldPrice >= 240) {
              var itemCardHTML = `<div class="div-block-14"><div class="ratio-box _16-9"><div class="conten-block with-image"><div class="img-container" style="background-image: url('${imageUrl}');"></div></div></div><div class="text-block-14">${soldPrice} kr</div><div class='text-block-34'>${brand}</div></div>`;
              var itemListRecentlySoldStartPage = document.getElementById('itemListRecentlySoldStartPage');
              itemListRecentlySoldStartPage.innerHTML += itemCardHTML;
            }
          }
        }
      })
      .catch((error) => {
        // Getting the Error details.
        var code = error.code;
        var message = error.message;
        var details = error.details;
        console.log('Error message: ', message, code);
      });
    // [END fb_functions_call_add_message_error]
  }


</script>

<script>

  function formatPhoneNumber(str) {
    if (str.slice(0, 1) == 0 && str.length == 10) {
      str = str.substring(1);
      str = "+46" + str;
    }
    if (str.slice(0, 1) == 7 && str.length == 9) {
      str = "+46" + str;
    }
    return str;
  }

  // FUNCTIONS - SELL ITEM
  function writePhoneNumberToFirestore(userID, phoneNumber) {
    var docRef = db.collection("users").doc(userID);
    console.log("writePhoneNumberToFirestore function is running!");

    var formattedPhoneNumber = formatPhoneNumber(phoneNumber);

    docRef.get().then((doc) => {
      if (doc.exists) {
        console.log("Document data:", doc.data());
      } else {
        // doc.data() will be undefined in this case
        console.log("No such document! Creating it now and adds phone number!");
        // Add a new document in collection "users"
        db.collection("users").doc(userID).set({
          phoneNumber: formattedPhoneNumber
        })
          .then(() => {
            console.log("User document successfully written!");
          })
          .catch((error) => {
            console.error("Error writing document: ", error);
          });
      }
    }).catch((error) => {
      console.log("Error getting document:", error);
    });
  }

  async function addItem() {

    console.log("addItem function is running!");
    let sex = "";
    let pricing = "";
    const now = new Date();
    let status = "New";
    let shippingStatus = "Not sent";
    const size = itemSize.value;
    const material = itemMaterial.value;
    const brand = itemBrand.value;
    const model = itemModel.value;
    const originalPrice = Number(itemOriginalPrice.value);
    const age = itemAge.value;

    const condition = itemCondition.value;
    const defectDescription = itemDefectDescription.value;
    const noAnimals = itemNoAnimals.checked;
    const noSmoke = itemNoSmoke.checked;
    let happyPrice = Number(itemHappyPrice.value);
    let acceptPrice = Number(itemAcceptPrice.value);
    const lowestAcceptPrice = Number(itemLowestAcceptPrice.value);
    const phoneNumber = itemPhoneNumber.value;

    let defectElements = new Map()
      .set("hole", hole.checked)
      .set("stain", stain.checked)
      .set("lostFit", lostFit.checked)
      .set("nopprig", nopprig.checked)
      .set("threadUp", threadUp.checked)
      .set("colorChange", colorChange.checked)
      .set("otherDefect", otherDefect.checked);

    let defectsChoicesInSwedish = new Map()
      .set("hole", "Hål")
      .set("stain", "Fläck")
      .set("lostFit", "Tappad passform")
      .set("nopprig", "Nopprig")
      .set("threadUp", "Trådsläpp")
      .set("colorChange", "Färgändring")
      .set("otherDefect", "Annat");

    let defects = [];

    defectElements.forEach(async (value, key) => {
      if (value == true) {
        let string = defectsChoicesInSwedish.get(key);
        defects.push(string);
      }
    });

    // Get radio buttons
    var sexRadioButtons = document.getElementsByName("Sex");
    for (var x = 0; x < sexRadioButtons.length; x++) {
      if (sexRadioButtons[x].checked) {
        sex = sexRadioButtons[x].id;
      }
    }

    // Get who sets price
    var pricingRadioButtons = document.getElementsByName("Pricing");
    for (var x = 0; x < pricingRadioButtons.length; x++) {
      if (pricingRadioButtons[x].checked) {
        pricing = pricingRadioButtons[x].id;
        if (pricing == "We set price") {
          acceptPrice = lowestAcceptPrice;
          happyPrice = 0;
        }
      }
    }

    // Add phone number to user document
    writePhoneNumberToFirestore(window.uid, phoneNumber);

    // Create item in FS without the images first, to get the ItemID
    var itemId = "";
    var imagePaths = {};
    var imageUrls = {};
    imageUrls['frontImage'] = ""; // Part of the ugly hack
    createItemInFirestore();

    async function createItemInFirestore() {

      const collectionRef = db.collection('items');

      // Writes to FS
      const res = await collectionRef.add({
        user: window.uid,
        createdAt: now,
        status: status,
        shippingStatus: shippingStatus,
        sex: sex,
        size: size,
        material: material,
        brand: brand,
        model: model,
        originalPrice: originalPrice,
        age: age,
        condition: condition,
        defects: defects,
        defectDescription: defectDescription,
        noAnimals: noAnimals,
        noSmoke: noSmoke,
        pricing: pricing,
        happyPrice: happyPrice,
        acceptPrice: acceptPrice,
        images: imageUrls // To compare the change after the images have been uploaded

      })
        .then((docRef) => {
          //window.itemId = docRef.id;
          itemId = docRef.id;
          console.log("Document written with ID: ", itemId);
          uploadImages();
        })
        .catch((error) => {
          console.error("Error adding document: ", error);
        });
    }

    async function uploadImages() {
      //Gather files from the form in a map "Images"
      let elements = ["frontImage", "brandTagImage", "productImage", "defectImage", "materialTagImage", "extraImage"];
      let images = new Map();

      elements.forEach(element => {
        if (document.getElementById(element).files[0]) {
          let file = document.getElementById(element).files[0];
          images.set(element, file);
        }
      });

      // Uploads files and gather URLs in an object "imagePaths"
      const storageRef = storage.ref();

      images.forEach(async (value, key) => {

        let imagePathReference = `images/${itemId}/${key}`;
        console.log(imagePathReference);

        let fileRef = storageRef.child(imagePathReference);
        await fileRef.put(value);

        const imageDownloadUrl = await fileRef.getDownloadURL();
        imageUrls[key] = imageDownloadUrl;
        imagePaths[key] = imagePathReference;

        if (Object.keys(imagePaths).length == images.size) {
          writeImagePathToFirestore();
        }
      })
    }

    async function writeImagePathToFirestore() {

      // Check if seller has added address first
      var addressFirstName = "";
      var docRef = db.collection("users").doc(window.uid);
      await docRef.get().then((doc) => {
        if (doc.data().addressFirstName) {
          addressFirstName = doc.data().addressFirstName;
        }
      }).catch((error) => {
        console.log("Error getting document:", error);
      });

      // Set the imagePaths of the item
      const itemRef = db.collection('items').doc(itemId);
      const res = await itemRef.update({
        images: imageUrls,
        imageStoragePaths: imagePaths
      }).then(function () {
        console.log(`imagePaths of ${itemId} is now updated`);

        if (addressFirstName == "") {
          addressFormDiv.style.display = 'block';
          addItemFormDiv.style.display = 'none';
        } else {
          window.location.href = window.location.origin + "/private";
        }
      });
    }
  }


  async function addUserAddress() {
    // Grab values from form
    const addressFirstName = document.getElementById("addressFirstName").value;
    const addressLastName = document.getElementById("addressLastName").value;
    const addressStreetAddress = document.getElementById("addressStreetAddress").value;
    const addressPostalCode = document.getElementById("addressPostalCode").value;
    const addressCity = document.getElementById("addressCity").value;
    const addressDoorCode = document.getElementById("addressDoorCode").value;

    // Write to Firestore
    const itemRef = db.collection('users').doc(window.uid);
    const res = await itemRef.update({
      addressFirstName: addressFirstName,
      addressLastName: addressLastName,
      addressStreetAddress: addressStreetAddress,
      addressPostalCode: addressPostalCode,
      addressCity: addressCity,
      addressDoorCode: addressDoorCode
    }).then(function () {
      console.log(`User address of ${uid} is now updated`);

      itemConfirmationDiv.style.display = 'block';
      addressFormDiv.style.display = 'none';
    });
  }

</script>

<script>
  function calculateSellerGets(value, elementId, feeElementId) {

    let div = document.getElementById(elementId);
    let feeDiv = document.getElementById(feeElementId);
    const price = parseFloat(value);
    let sellerGets = 0;

    if (price < 250) {
      sellerGets = Math.ceil(price - 50);
      if (sellerGets < 0) {
        sellerGets = 0;
      }
      feeDiv.innerText = `Minst 50kr kommission`;
    } else {
      sellerGets = Math.ceil(price * 0.8);
      feeDiv.innerText = `20% kommission`;
    }

    if (sellerGets >= 0) {
      div.innerText = `Du får ${sellerGets} kr`;
      div.style.display = 'block';

    } else {
      div.style.display = 'none';
    }
  }
</script>